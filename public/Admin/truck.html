<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="a_style.css">
  <link rel="stylesheet" href="admin-shell.css">
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyA9SQW3iUwZWCgeG6eOYvvMU5g2hb_Zlrw",
      authDomain: "smartwaste2568-1d792.firebaseapp.com",
      databaseURL: "https://smartwaste2568-1d792-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartwaste2568-1d792",
      storageBucket: "smartwaste2568-1d792.firebasestorage.app",
      messagingSenderId: "1041339993312",
      appId: "1:1041339993312:web:65b26ea83dcbf4f8b29485",
      measurementId: "G-FV5TEPVZWN",
      databaseURL: "https://smartwaste2568-1d792-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  <script src="../Login/auth.js"></script>
  <script src="admin-lang.js"></script>
  <script src="admin-shell.js" defer></script>
  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>
  <script src="admin-user.js" defer></script>
  <script src="admin-nav.js" defer></script>
  <script src="admin-profile.js" defer></script>
  <script src="admin-auth-bootstrap.js" defer></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <style>
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô css ‡∏Å‡∏•‡∏≤‡∏á) */
    body {
      overflow-x: hidden;
    }

    /* ================================
   ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ (‡∏´‡∏ô‡πâ‡∏≤ dashboard / home)
   ================================ */
    .truck-page{
      max-width: 100%;
      margin: 0 auto;
      padding: 10px 12px 0;
    }
    .page-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin: 8px 0 18px;
    }
    .page-title{
      margin:0;
      font-size:38px;
      font-weight:900;
      color:#1f2937;
      letter-spacing:-0.4px;
    }
    .page-sub{
      margin:6px 0 0;
      font-size:18px;
      font-weight:800;
      color:#6b7280;
    }
    .card-surface{
      background:#fff;
      border:1px solid #e6ebf3;
      border-radius:18px;
      box-shadow: 0 12px 26px rgba(17,24,39,.08);
      padding:18px;
    }
    .truck-page .content{
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      margin: 0;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
      margin: 4px 0 16px;
      width: 100%;
      overflow: hidden;
    }

    .cards .card {
      background: #fff;
      padding: 18px;
      border-radius: 14px;
      border: 1px solid #e6ebf3;
      text-align: center;
      box-shadow: 0 6px 16px rgba(17, 24, 39, .08);
      transition: .2s;
      margin: 0;
      min-width: 0;
    }

    .cards .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(17,24,39,.12);
    }

    .cards .card h3 {
      font-size: 18px;
      color: #1f2937;
      margin: 0 0 6px;
    }

    .cards .card p {
      font-size: 24px;
      font-weight: 900;
      color: #0284c7;
      margin: 0;
      letter-spacing: 0.2px;
    }

    /* ================================
   ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
   ================================ */
    .filter-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .filter-row select{
      flex:1 1 260px;
      min-width: 220px;
      min-height: 44px;
      padding: 10px 12px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      box-shadow: 0 10px 18px rgba(17, 24, 39, .02);
    }
    .filter-row select:focus{
      outline: 2px solid rgba(14,165,233,.25);
      border-color: rgba(14,165,233,.55);
      outline-offset: 2px;
    }
    .filter-row button{
      min-height: 52px;
      padding: 0 18px;
      white-space: nowrap;
      align-self: stretch;
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ ‡πÉ‡∏´‡πâ‡πÇ‡∏ó‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö action menu */
    #btnCreate{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 0 18px;
      min-height:52px;
      background: #10b981; /* ‡∏™‡∏µ‡∏ó‡∏∂‡∏ö ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ gradient */
      color:#fff;
      border:1px solid rgba(16,185,129,.32);
      border-radius:14px;
      font-weight:900;
      letter-spacing: -0.1px;
      box-shadow: 0 12px 24px rgba(16,185,129,.22);
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    #btnCreate:hover{
      box-shadow: 0 14px 28px rgba(16,185,129,.26);
      filter: brightness(1.03);
    }
    #btnCreate:active{ transform: translateY(1px) scale(.99); }
    #btnCreate .btnCreateLabel{
      font-size:18px;
      line-height:1;
      display:inline-block;
      transform: translateY(-1px);
    }
    #map {
      width: 100%;
      height: 460px;
      border-radius: 0;
      border: none;
      display:block;
    }
    .map-wrapper{
      margin-top: 14px;
      border-radius: 16px;
      overflow: hidden;
      border:1px solid #e6ebf3;
      box-shadow: 0 10px 22px rgba(17,24,39,.08);
      background:#f8fafc;
    }

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö report */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  margin-top: 0;
  border-top:1px solid #e6ebf3;
  border-radius: 0;
  background:#f8fafc; /* ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô */
}
.table-toolbar{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:12px;
  padding: 18px 18px 12px 18px;
  background:#fff;
  border-bottom:1px solid #e6ebf3;
}
.search-box{ margin-left:auto; width: 280px; max-width: 100%; }
.search-box input{
  width:100%;
  height:44px;
  min-height:44px;
  border-radius:16px;
  font-size:13px;
  font-weight:800;
  padding:10px 12px;
  border: 1px solid #e2e8f0;
  background:#fff;
  box-shadow: 0 10px 18px rgba(17,24,39,.02);
}
.search-box input:focus{
  outline: 2px solid rgba(14,165,233,.25);
  border-color: rgba(14,165,233,.55);
  outline-offset: 2px;
}
.usage-table{
  width:100%;
  min-width: 920px;
  border-collapse: collapse;
  border-spacing: 0;
  font-size:14px;
  margin-top: -1px; /* ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô report */
}
.usage-table th,
.usage-table td{
  text-align: center;
  vertical-align: middle;
  padding: 12px 12px;
  border-bottom:1px solid #e6ebf3;
  color:#0f172a;
}
.usage-table thead th{
  background:#f8fafc;
  color:#374151;
  font-weight: 800;
  font-size: 13px;
  line-height:1.2;
  padding-top:14px;
  padding-bottom:14px;
  position: sticky;
  top:0;
  z-index: 2;
}
    .usage-table td.date,
    .usage-table th.date{
      text-align: left;
    }
    .usage-table td.truck,
    .usage-table th.truck{
      text-align: left;
      font-weight: 800;
    }
    .usage-table td.driver,
    .usage-table th.driver{
      text-align: left;
      font-weight: 800;
    }
    .usage-table tbody tr[data-truck]{
      cursor: pointer;
    }
.usage-table tbody tr:hover{
  background:#f8fafc;
}
    .usage-table tbody tr:last-child td{
      border-bottom: none;
    }
.usage-table td{
  background:#fff;
}
.usage-table td.zone{
  padding: 12px 12px;
}
.badge-zone{
  padding:6px 12px;
  border-radius: 999px;
  background: linear-gradient(135deg, rgba(16,185,129,.18), rgba(14,165,233,.18));
  color: #0f172a;
  font-weight: 900;
  font-size: 13px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width: 90px;
  border: 1px solid rgba(16,185,129,.14);
}
    .left{ text-align:left; }
    .center{ text-align:center; }

    .swal2-container {
      z-index: 2000 !important;
    }

    /* ================================
   Overlay ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ modal ‡∏Å‡∏•‡∏≤‡∏á)
   ================================ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;  /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
      justify-content: center;
      padding: 16px 12px;
      z-index: 1500; /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏°‡∏ô‡∏π/‡πÄ‡∏Æ‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå */
    }

    .overlay-card {
      width: min(460px, 92vw);
      max-width: 520px;
      background: #fff;
      border-radius: 12px;
      border-top: 4px solid #10b981;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.18);
      padding: 16px 18px 16px !important;
      transform: translateY(0);
      opacity: 0;
      animation: overlayIn .18s ease-out forwards;
      display:flex;
      flex-direction:column;
      gap: 10px;
      height: auto;
      max-height: 90vh;
    }
    /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà */
    #createPanel h3{
      margin: 0 0 6px;
      padding: 0;
      font-size: 20px;
      font-weight: 900;
    }
    #createPanel .form-row{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    #createPanel .form-row label{
      display:block;
      font-weight:800;
      color:#0f172a;
      margin-bottom:4px;
      font-size:14px;
    }
    #createPanel .form-row select,
    #createPanel .form-row input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e2e8f0;
      background:#fff;
      font-weight:700;
      color:#0f172a;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
      height:44px;
      font-size:14px;
    }
    #createPanel select:focus,
    #createPanel input:focus{
      outline:2px solid rgba(14,165,233,.25);
      border-color: rgba(14,165,233,.55);
      box-shadow: 0 6px 14px rgba(14,165,233,.14);
      background:#fff;
    }
    #createPanel input[readonly]{
      background:#f1f5f9;
      color:#475569;
    }
    #createPanel .overlay-actions{
      display:flex;
      flex-direction:row;
      justify-content:center; /* ‡∏à‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á */
      gap:10px;
      margin-top:12px;
    }
    #createPanel .overlay-actions button{
      min-height:44px;
      font-weight:800;
      border-radius:12px;
      padding:10px 16px;
      font-size:14px;
    }
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà */
    #btnCancelCreate{
      background:#e5e7eb !important;
      color:#0f172a !important;
      border:1px solid #d1d5db !important;
    }
    #btnSaveTruck{
      background:#10b981 !important; /* ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ */
      color:#fff !important;
      border:1px solid rgba(16,185,129,.35) !important;
      box-shadow: 0 8px 18px rgba(16,185,129,.18);
    }

    /* --- Override: compact create truck overlay --- */
    #createOverlay .overlay-card{
      width: min(460px, 92vw) !important;
      max-width: 520px !important;
      padding: 16px 18px 16px !important;
      gap: 10px !important;
    }
    #createOverlay #createPanel h3{
      margin: 0 0 6px !important;
      font-size: 20px !important;
    }
    #createOverlay #createPanel .form-row{
      gap: 6px !important;
      margin: 0 !important;
    }
    #createOverlay #createPanel .form-row label{
      margin-bottom: 4px !important;
      font-size: 14px !important;
    }
    #createOverlay #createPanel .form-row select,
    #createOverlay #createPanel .form-row input{
      padding: 10px 12px !important;
      border-radius: 12px !important;
      height: 44px !important;
      font-size: 14px !important;
    }
    #createOverlay #createPanel .overlay-actions{
      gap: 10px !important;
      margin-top: 12px !important;
    }
    #createOverlay #createPanel .overlay-actions button{
      min-height: 44px !important;
      padding: 10px 16px !important;
      border-radius: 12px !important;
      font-size: 14px !important;
    }

    /* Âº∑Âà∂‡∏¢‡πà‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏ß‡∏¢ inline width fallback */
    #createOverlay .overlay-card.compact{
      width: 440px !important;
      max-width: 92vw !important;
      padding: 16px 18px 16px !important;
      gap: 8px !important;
      border-radius: 16px !important;
      height: auto !important;
      max-height: 90vh !important;
    }
    #createOverlay .overlay-card.compact select,
    #createOverlay .overlay-card.compact input{
      height: 44px !important;
      padding: 10px 12px !important;
      font-size: 14px !important;
      border-radius: 12px !important;
    }
    body.overlay-open{
      overflow:hidden;
    }
    #createPanel .overlay-actions button{
      min-height:44px;
      font-weight:800;
      border-radius:12px;
      padding:10px 16px;
      font-size:14px;
    }

    .overlay-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      justify-content: center;
    }

    @keyframes overlayIn {
      from {
        opacity: 0;
        transform: translateY(8px) scale(.96);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @media (min-width: 640px) {
      .overlay-actions {
        flex-direction: row;
        justify-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà */
      }

      .overlay-actions button {
        min-width: 120px;
      }
    }

    /* ================================
   ICON ‡∏£‡∏ñ (Leaflet)
   ================================ */
    .leaflet-marker-icon.truck-icon {
      background: transparent;
      border: none;
    }

    .truck-pin {
      --pin-color: #f43f5e;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      filter: drop-shadow(0 8px 15px rgba(244, 63, 94, 0.4));
    }

    .truck-pin__bubble {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid var(--pin-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #111827;
    }

    .truck-pulse {
      position: absolute;
      width: 48px;
      height: 48px;
      background: var(--pin-color);
      border-radius: 50%;
      opacity: 0.5;
      animation: pulse-ring 4s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      z-index: -1;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    /* ================================
   ICON ‡∏ñ‡∏±‡∏á (Leaflet)
   ================================ */
    .leaflet-marker-icon.bin-icon {
      background: transparent;
      border: none;
    }

    .bin-pin {
      --pin-color: #16a34a;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      filter: drop-shadow(0 10px 20px rgba(15, 23, 42, .25));
    }

    .bin-pin__bubble {
      width: 46px;
      height: 46px;
      border-radius: 16px 16px 12px 12px;
      background: linear-gradient(135deg, var(--pin-color), rgba(255, 255, 255, .2));
      border: 2px solid rgba(255, 255, 255, .85);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #0f172a;
    }

    .bin-pin__pointer {
      width: 0;
      height: 0;
      border: 10px solid transparent;
      border-top-color: var(--pin-color);
      margin-top: -6px;
      filter: brightness(.9);
    }

    .bin-pin__label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      padding: 2px 8px;
      line-height: 1;
      box-shadow: 0 4px 10px rgba(15, 23, 42, .12);
    }

    .bin-pin__label.is-unknown {
      color: #475569;
      background: #f8fafc;
    }

    /* ================================
   Responsive ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô cards + map
   ================================ */
    @media(max-width:900px) {
      #map {
        height: 45vh;
      }

      .cards {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .cards .card {
        padding: 14px 12px;
      }

      .cards .card h3 {
        font-size: 15px;
        margin-bottom: 4px;
      }

      .cards .card p {
        font-size: 18px;
      }
    }

    .sw-popup {
      border-radius: 14px !important;
      font-family: 'Prompt', sans-serif;
    }

    /* =========================
   Mobile table scroll (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô report)
   ========================= */
    @media(max-width: 720px){
      .truck-table-card{
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
        border-radius: 16px;
      }
      .truck-table-card .table-toolbar{
        position: sticky;
        top: 0;
        z-index: 6;
        background:#fff;
        overflow-x: auto;
      }
      /* filter + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      .filter-row{
        flex-wrap: nowrap;
        gap:8px;
      }
      .filter-row select{
        flex:1 1 auto;
        min-width: 0;
        height:44px;
        border-radius:12px;
      }
      #btnCreate{
        min-height:44px;
        padding: 0 14px;
        border-radius:12px;
      }
      #usageHint{
        display:none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏ô‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      }
      .table-wrapper{
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        border-top: 0;
      }
      .usage-table{
        min-width: 640px;
      }
      /* ‡∏à‡∏±‡∏î toolbar ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô report */
      .table-toolbar{
        flex-direction: column;
        align-items: flex-start;
        gap:8px;
        padding: 14px 14px 10px 14px;
      }
      .table-toolbar h4{
        margin:0;
        width:100%;
      }
      .table-toolbar .search-box{
        width:100%;
        min-width:0;      /* ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î/‡∏´‡∏î‡πÄ‡∏ó‡πà‡∏≤ report */
        max-width:100%;
        margin-left:0;
      }
      .table-toolbar .search-box input{
        width:100%;
      }
    }

    /* =========================
   Language Dropdown (Login Style)
   ========================= */
    .lang-switcher {
      position: relative;
    }

    .lang-switcher .icon-btn {
      width: 44px;
      height: 44px;
      min-height: 44px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .lang-switcher .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.16);
    }
    .lang-switcher .icon-btn:active { transform: scale(0.96); }

    .lang-menu {
      position: absolute;
      top: 54px;
      right: 0;
      background: #ffffff;
      border-radius: 18px;
      padding: 8px;
      min-width: 190px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18);
      display: none;
      flex-direction: column;
      gap: 6px;
      z-index: 1200;
    }

    .lang-menu.show {
      display: flex;
    }

    .lang-menu button {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border-radius: 12px;
      border: none;
      background: transparent;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
      color: #0f172a;
    }

    .lang-menu button:hover {
      background: #f1f5f9;
    }

    .lang-menu button:active {
      background: #e2e8f0;
    }

    .lang-menu button.active {
      background: #e0f2fe;
      color: var(--accent, #0ea5e9);
      font-weight: 700;
    }
  </style>
</head>

<body data-active-nav="truck">

  <main>
    <div id="pageLoader" class="shell-loader">
      <div class="loader-box">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      </div>
    </div>

    <div class="truck-page">
      <div class="page-head">
        <div>
          <h1 class="page-title" id="pageTitleHeading"></h1>
          <p class="page-sub" id="pageSubtitle"></p>
        </div>
        <select id="langSelect" style="display:none;">
          <option value="th">‡πÑ‡∏ó‡∏¢</option>
          <option value="en">English</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>

      <div class="content">
      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á -->
      <div class="cards">
        <div class="card">
          <h3 id="cardTotalTitle"></h3>
          <p id="totalBins">‚Äî</p>
        </div>
        <div class="card">
          <h3 id="cardMidTitle"></h3>
          <p id="onlineBins">‚Äî</p>
        </div>
        <div class="card">
          <h3 id="cardFullTitle"></h3>
          <p id="fullBins">‚Äî</p>
        </div>
        <div class="card">
          <h3 id="cardLowTitle"></h3>
          <p id="lowBins">‚Äî</p>
        </div>
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏ñ -->
      <div class="card">
        <div class="row" style="align-items: flex-end; gap:10px;">
          <div style="flex:1 1 260px">
            <label for="zoneFilter" id="zoneFilterLabel"></label>
            <div class="filter-row">
              <select id="zoneFilter">
                <option value=""></option>
              </select>
              <button id="btnCreate" class="ghost"><span class="btnCreateLabel">+</span></button>
            </div>
            <p id="truckInfo" class="muted" style="margin-top:6px"></p>
          </div>
        </div>
        <div class="map-wrapper">
          <div id="map"></div>
        </div>
      </div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á -->
      <div class="card truck-table-card" style="background:#fff; border:1px solid #e6ebf3; box-shadow:0 10px 22px rgba(17,24,39,.06); padding:0; border-radius:18px; overflow:hidden;">
        <div class="table-toolbar">
          <div>
            <h4 id="usageTitle" style="margin:0; font-size:18px; font-weight:900;"></h4>
            <p class="muted" id="usageHint" style="margin:4px 0 0;"></p>
          </div>
        </div>
        <p class="muted" id="usageStatus" style="margin:0; padding:0; height:0; line-height:0; overflow:hidden;"></p>

        <div class="table-wrapper">
          <table class="usage-table">
            <thead>
              <tr>
                <th class="truck" id="usageThTruck"></th>
                <th class="driver" id="usageThDriver"></th>
    <th class="date" id="usageThDate"></th>
    <th id="usageThZone"></th>
    <th id="usageThStart"></th>
    <th id="usageThDuration"></th>
              </tr>
            </thead>
            <tbody id="usageBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà -->
  <div id="createOverlay" class="overlay" style="display:none;">
    <div id="createPanel" class="card overlay-card compact">
      <h3 id="createPanelTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞</h3>

      <div class="form-row">
        <div>
            <label id="zoneSelectLabel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</label>
            <select id="truckZoneSelect">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option>
            </select>
        </div>

      </div>

      <div class="form-row">
        <div>
            <label id="truckIdLabel">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ</label>
            <input id="truckIdPreview" readonly />
        </div>
      </div>

      <div class="overlay-actions" style="margin-top:12px;">
          <button id="btnCancelCreate" class="ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="btnSaveTruck" type="button" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>

    </div>
  </div>


  <script>

    const fs = firebase.firestore();

    /* Map */
    const start = [6.46007, 100.35933];
    const map = L.map('map', {
      preferCanvas: true
    }).setView(start, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // markers: ‡∏£‡∏ñ + ‡∏ñ‡∏±‡∏á
    const truckMarkers = {};         // truckId -> marker
    const truckDocUnsubMap = {};     // truckId -> unsubscribe truck doc
    const truckRunsUnsubMap = {};    // truckId -> unsubscribe active runs
    const truckActiveMap = {};       // truckId -> bool
    const truckZoneMap = {};         // truckId -> zoneId
    const truckDisplayNameMap = {};  // truckId -> display name

    const binMarkers = {};           // zone_binDocId -> marker
    let binsDataUnsub = null;        // listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bin_data
    let binsDataState = {};          // docId -> {lat,lng,binId}
    let binsLevelState = {};   // mac -> fillLevel

    /* Dashboard realtime state */
    const dashboardState = {};       // zoneId -> { totalBins, levelByBin: {binKey:fill} }
    let dashboardUnsubs = [];
    let hasLiveFromRTDB = false;

    /* UI refs */
    const langIconBtn = document.getElementById("langIconBtn");
    const langMenu = document.getElementById("langMenu");
    const langSelect = document.getElementById('langSelect');
    const syncLangMenuActive = (lang) => {
      if (!langMenu || !lang) return;
      langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });
    };
    const pageLoader = document.getElementById("pageLoader");
    const loaderTextEl = document.getElementById("loaderText");

    function showPageLoader(text){
      if(text && loaderTextEl) loaderTextEl.textContent = text;
      if(pageLoader) pageLoader.classList.add("show");
    }
    function hidePageLoader(){
      if(pageLoader) pageLoader.classList.remove("show");
    }
    const adminNameEl = document.getElementById('adminName');
    const adminAvatarEl = document.getElementById('adminAvatar');
    const adminRoleEl = document.getElementById('adminRole');

    const zoneFilter = document.getElementById('zoneFilter');
    const truckInfo = document.getElementById('truckInfo');
    const btnCreate = document.getElementById('btnCreate');

    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á
    const totalEl = document.getElementById('totalBins');
    const fullEl = document.getElementById('fullBins');
    const midEl = document.getElementById('onlineBins');
    const lowEl = document.getElementById('lowBins');

    // usage table
    const usageBody = document.getElementById('usageBody');
    const usageStatus = document.getElementById('usageStatus');

    // ‡πÅ‡∏ú‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ (overlay)
    const createOverlay = document.getElementById('createOverlay');
    const createPanel = document.getElementById('createPanel');
    const btnSaveTruck = document.getElementById('btnSaveTruck');
    const btnCancelCreate = document.getElementById('btnCancelCreate');

    // ===== Truck form elements =====
    const truckZoneSelect = document.getElementById("truckZoneSelect");
    const truckIdPreview = document.getElementById("truckIdPreview");


    const displayName =
      window.ADMIN_AUTH?.fullName ||
      window.ADMIN_AUTH?.username ||
      "-";

    if (adminNameEl) adminNameEl.textContent = displayName || "-";
    if (adminAvatarEl) adminAvatarEl.textContent =
      displayName ? displayName.charAt(0).toUpperCase() : "?";

    function lockBodyScroll(lock) {
      document.body.classList.toggle("modal-open", !!lock);
    }

    let currentUserProfile = null;
    /* ===== Language / i18n (SAFE VERSION ‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ) ===== */
    const LangState = window.AdminLang;

    let currentLang =
      (LangState && typeof LangState.getLang === "function")
        ? LangState.getLang()
        : (localStorage.getItem("sw_lang") || "th");
    syncLangMenuActive(currentLang);

    function t(key) {
      const dict =
        (window.SW_Translations && window.SW_Translations[currentLang]) ||
        (window.SW_Translations && window.SW_Translations.th) ||
        {};
      return dict[key] !== undefined ? dict[key] : key;
    }


    function setStatusForm(text, type) {
      if (typeof msg === "undefined" || !msg) return;
      msg.textContent = text || "";
      msg.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
    }
    function setBinsStatus(text, type) {
      if (typeof binsStatusEl === "undefined" || !binsStatusEl) return;
      binsStatusEl.textContent = text || "";
      binsStatusEl.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
    }
    function errStr(e) {
      return (e && (e.code ? e.code + ": " + (e.message || "") : (e.message || String(e)))) || "unknown";
    }

    /* ===== Helper ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ / listener ===== */
    // ===== ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Firestore =====
    async function loadTodaySchedule(zoneId) {
      if (!zoneId) return null;

      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

      const ref = fs
        .collection("truck_schedule")
        .doc(zoneId)
        .collection("days")
        .doc(today);

      const snap = await ref.get();
      if (!snap.exists) return null;

      return snap.data();
    }

    let usageUnsub = null;
    let currentZoneFilter = ""; // "" = ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï
    const ZONE_FILTER_KEY = "sw_admin_zone_filter";
    const warnedNoSchedule = {}; // truckId_YYYY-MM-DD => true
    let trucks = []; // {id, data}
    let isUsageTableControlledByFirestore = false;

    function formatDurationMs(ms) {
      const durSec = Math.max(0, Math.round(ms / 1000));
      const h = Math.floor(durSec / 3600);
      const m = Math.floor((durSec % 3600) / 60);
      const s = durSec % 60;

      return t('durationFormat')
        .replace('%h%', h)
        .replace('%m%', m)
        .replace('%s%', s);

    }

    function updateTruckPopupsLanguage() {
      Object.keys(truckMarkers).forEach(truckId => {
        const marker = truckMarkers[truckId];
        if (!marker) return;
        const displayName = truckDisplayNameMap[truckId] || truckId || "-";
        const statusLabel = truckActiveMap[truckId] ? t('truckActiveLabel') : t('truckInactiveLabel');
        const popupHtml = `<b>${displayName}</b><br>${statusLabel}`;
        if (marker.getPopup()) marker.getPopup().setContent(popupHtml);
        else marker.bindPopup(popupHtml);
      });
    }

    function showUsageMessage(key) {
      usageBody.innerHTML = `
    <tr>
      <td colspan="6" class="muted">
        ${t(key)}
      </td>
    </tr>
  `;
      usageStatus.textContent = "";
    }

    function detachUsage() {
      if (typeof usageUnsub === 'function') {
        usageUnsub();
        usageUnsub = null;
      }
      isUsageTableControlledByFirestore = false; // ‚úÖ ‡∏õ‡∏•‡∏î lock
      hasLiveFromRTDB = false;
    }

    function getBinStatusColor(isOnline, fillLevel) {
      if (!isOnline) return "#94a3b8"; // ‡πÄ‡∏ó‡∏≤ (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)
      if (typeof fillLevel === "number" && fillLevel >= 80) return "#dc2626"; // ‡πÅ‡∏î‡∏á (‡πÄ‡∏ï‡πá‡∏°)
      return "#16a34a"; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏õ‡∏Å‡∏ï‡∏¥)
    }

    /* ===== helper icon ‡∏£‡∏ñ‡πÅ‡∏ö‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ===== */
    function buildTruckIcon(isActive) {
      const statusEmoji = "üöõ";
      const color = isActive ? "#f43f5e" : "#94a3b8";
      const pulse = isActive ? `<div class="truck-pulse"></div>` : "";
      return L.divIcon({
        className: "truck-icon",
        html: `
          <div class="truck-pin" style="--pin-color:${color};">
            ${pulse}
            <div class="truck-pin__bubble">${statusEmoji}</div>
          </div>
        `.trim(),
        iconSize: [50, 50],
        iconAnchor: [25, 25],
        popupAnchor: [0, -30]
      });
    }

    /* ===== ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ã‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter ===== */
    async function loadZonesForFilter() {
      zoneFilter.innerHTML = `<option value="">${t('zoneFilterAll')}</option>`;
      const snap = await fs.collection('zones').get();

      snap.forEach(doc => {
        const d = doc.data() || {};
        const opt = document.createElement('option');
        opt.value = doc.id;
        opt.textContent = d.name || doc.id;
        zoneFilter.appendChild(opt);
      });

      // ‚úÖ restore ‡πÇ‡∏ã‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ç‡πâ‡∏≠ 3)
      const saved = localStorage.getItem(ZONE_FILTER_KEY) || "";
      zoneFilter.value = saved;
      currentZoneFilter = saved;
    }

    /* ===== ‡πÇ‡∏´‡∏•‡∏î trucks + listeners ‡∏£‡∏ñ ===== */
    function clearTruckListenersAndMarkers() {
      Object.values(truckDocUnsubMap).forEach(fn => fn && fn());
      Object.values(truckRunsUnsubMap).forEach(fn => fn && fn());
    }

    async function loadTrucks() {
      clearTruckListenersAndMarkers();
      trucks = [];
      for (const k in truckZoneMap) delete truckZoneMap[k];

      const zonesSnap = await fs.collection("trucks").get();

      for (const zoneDoc of zonesSnap.docs) {
        const zoneId = zoneDoc.id;

        const trucksSnap = await fs
          .collection("trucks")
          .doc(zoneId)
          .collection("vehicles")
          .get();

        trucksSnap.forEach(doc => {
          const d = doc.data() || {};
          const truckId = doc.id;

          trucks.push({
            id: truckId,
            data: {
              ...d,
              zone: zoneId // ‚úÖ ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡πÑ‡∏´‡∏ô
            }
          });
          truckZoneMap[truckId] = zoneId;
        });
      }

      // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô (‡∏Ç‡πâ‡∏≠ 1,2)
      trucks.forEach(tr => {
        const truckId = tr.id;

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ marker ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°
        if (truckMarkers[truckId]) return;

        // lat/lng ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å: (1) RTDB ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≥‡πÑ‡∏ß‡πâ (2) Firestore vehicles ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Å‡πá‡∏ö
        const last = truckLastPosMap[truckId];
        const lat = (typeof last?.lat === "number") ? last.lat : tr.data.lat;
        const lng = (typeof last?.lng === "number") ? last.lng : tr.data.lng;

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏£‡∏ñ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠ RTDB ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
        if (typeof lat !== "number" || typeof lng !== "number") return;

        const isActive = !!truckActiveMap[truckId]; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå = false
        const marker = L.marker([lat, lng], { icon: buildTruckIcon(isActive) }).addTo(map);
        truckMarkers[truckId] = marker;
        const displayName = tr.data.name || tr.data.truckId || truckId;
        truckDisplayNameMap[truckId] = displayName;
        marker.bindPopup(`<b>${displayName}</b><br>${t('truckInactiveLabel')}`);
      });

      // ‚úÖ ‡πÉ‡∏´‡πâ filter ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô marker ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      updateAllTruckMarkersVisibility();

      updateTruckInfoPanel();
    }

    function updateAllTruckMarkersVisibility() {
      Object.keys(truckMarkers).forEach(truckId => updateTruckMarkerVisibility(truckId));
    }
    function updateTruckMarkerVisibility(truckId) {
      const marker = truckMarkers[truckId];
      if (!marker) return;

      const zoneId = truckZoneMap[truckId] || "";
      const isActive = !!truckActiveMap[truckId];

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï icon ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ online/offline
      marker.setIcon(buildTruckIcon(isActive));

      const visible = !currentZoneFilter ? true : (zoneId === currentZoneFilter);

      if (visible) {
        if (!map.hasLayer(marker)) map.addLayer(marker);
      } else {
        if (map.hasLayer(marker)) map.removeLayer(marker);
      }
    }

    function focusTruckOnMap(truckId) {
      if (!truckId) return;
      const marker = truckMarkers[truckId];
      if (marker) {
        const latLng = marker.getLatLng();
        const nextZoom = Math.max(map.getZoom(), 16);
        map.setView(latLng, nextZoom, { animate: true });
        if (marker.getPopup()) marker.openPopup();
        return;
      }
      const last = truckLastPosMap[truckId];
      if (last && typeof last.lat === "number" && typeof last.lng === "number") {
        const nextZoom = Math.max(map.getZoom(), 16);
        map.setView([last.lat, last.lng], nextZoom, { animate: true });
      }
    }

    function updateTruckInfoPanel() {
      if (!currentZoneFilter) {
        const activeIds = Object.keys(truckActiveMap).filter(id => truckActiveMap[id]);
        if (!activeIds.length) {
          truckInfo.textContent = t('truckInfoAllNone');
        } else {
          truckInfo.innerHTML = t('truckInfoAllSome').replace('%count%', activeIds.length);
        }
        return;
      }

      const activeTrucks = trucks.filter(tr =>
        (tr.data.zone || "") === currentZoneFilter && !!truckActiveMap[tr.id]
      );

      if (!activeTrucks.length) {
        truckInfo.textContent = t('truckInfoZoneNoTruck');
        return;
      }

      const truck = activeTrucks[0];
      const d = truck.data;
      const isActive = !!truckActiveMap[truck.id];
      const updatedStr = d.updatedAt && d.updatedAt.toDate
        ? d.updatedAt.toDate().toLocaleString()
        : t('dashPlaceholder');

      const base = t('truckInfoText')
        .replace('%id%', d.truckId || truck.id)
        .replace('%zone%', d.zoneName || d.zone || currentZoneFilter)
        .replace('%name%', d.name || t('dashPlaceholder'))
        .replace('%updatedAt%', updatedStr);

      const statusLabel = isActive ? t('truckActiveLabel') : t('truckInactiveLabel');
      truckInfo.innerHTML = `${base} ‚Ä¢ <span class="ok">${statusLabel}</span>`;
    }

    function applyZoneFilter(nextZoneId) {
      currentZoneFilter = nextZoneId || "";
      localStorage.setItem(ZONE_FILTER_KEY, currentZoneFilter);

      updateAllTruckMarkersVisibility();
      updateTruckInfoPanel();
      updateUsageTableVisibility();

      if (currentZoneFilter) setupBinsForZone(currentZoneFilter);
      else clearBinMarkers();
    }

    /* ===== ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (realtime ‡∏à‡∏≤‡∏Å bin_data + bin_level) ===== */
    function clearBinMarkers() {
      if (binsDataUnsub) {
        binsDataUnsub();
        binsDataUnsub = null;
      }

      Object.values(binMarkers).forEach(m => {
        if (map.hasLayer(m)) map.removeLayer(m);
      });
      for (const k in binMarkers) delete binMarkers[k];
      binsDataState = {};
    }

    
    function redrawBinMarkers(zoneId) {
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå marker ‡πÄ‡∏î‡∏¥‡∏°
      Object.values(binMarkers).forEach(m => {
        if (map.hasLayer(m)) map.removeLayer(m);
      });
      for (const k in binMarkers) delete binMarkers[k];

      const NOW = Date.now();
      const ONLINE_TIMEOUT = 30000;

      Object.entries(binsDataState).forEach(([binId, info]) => {
        const levelInfo = binsLevelState[info.mac];
        const fill =
          typeof levelInfo?.fillLevel === "number"
            ? levelInfo.fillLevel
            : null;

        const isOnline =
          levelInfo && (NOW - levelInfo.lastUpdate <= ONLINE_TIMEOUT);

        const color = getBinStatusColor(isOnline, fill);

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á icon ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á % ‡∏ó‡∏µ‡πà marker
        const icon = L.divIcon({
          className: "bin-icon",
          html: `
        <div class="bin-pin" style="--pin-color:${color};">
          <div class="bin-pin__bubble">üóëÔ∏è</div>
          <div class="bin-pin__pointer"></div>
          <div class="bin-pin__label ${isOnline ? "" : "is-unknown"}">
            ${fill !== null ? fill + "%" : t('dashPlaceholder')}
          </div>
        </div>
      `,
          iconSize: [50, 64],
          iconAnchor: [25, 52],
          popupAnchor: [0, -48]
        });

        const marker = L.marker([info.lat, info.lng], { icon })
          .bindPopup(
            `${t('mapPopupBin')}<br>` +
            (isOnline ? t('statusOnline') : t('statusOffline')) +
            (fill !== null ? `<br>${t('binLevel')} ${fill}%` : "")
          );

        marker.addTo(map);
        binMarkers[zoneId + "_" + binId] = marker;
      });

      fitMapToAllMarkers();
    }

    function setupBinsForZone(zoneId) {
      clearBinMarkers();
      if (!zoneId) return;

      const dataRef = fs.collection('smartbins')
        .doc(zoneId)
        .collection('bin_data');

      binsDataState = {};   // binId -> { lat, lng, mac }

      // ‚úÖ ‡∏ü‡∏±‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Firestore
      binsDataUnsub = dataRef.onSnapshot(snap => {
        if (zoneId !== currentZoneFilter) return;
        const newState = {};
        snap.forEach(doc => {
          const d = doc.data() || {};
          if (d.isHidden || d.deletedAt) return;
          if (!d.macAddress) return;

          newState[d.binId || doc.id] = {
            lat: d.lat,
            lng: d.lng,
            mac: d.macAddress
          };
        });

        binsDataState = newState;
        redrawBinMarkers(zoneId);
      });
    }

    /* ===== RTDB Realtime Listener (fillLevel) ===== */
    const rtdbRef = firebase.database().ref("esp32_devices");

    rtdbRef.on("value", snap => {
      const devices = snap.val() || {};

      binsLevelState = {};
      Object.entries(devices).forEach(([mac, d]) => {
        if (typeof d?.fillLevel === "number") {
          binsLevelState[mac] = {
            fillLevel: d.fillLevel,
            lastUpdate: d.lastUpdate || 0
          };
        }
      });

      if (currentZoneFilter) {
        redrawBinMarkers(currentZoneFilter);
      }

      recomputeDashboard();
    });

    let binStatusTicker = null;
    function startBinStatusTicker() {
      if (binStatusTicker) return;
      binStatusTicker = setInterval(() => {
        recomputeDashboard();
        if (currentZoneFilter) redrawBinMarkers(currentZoneFilter);
      }, 5000);
    }

    function getTruckForZone(zoneId) {
      return trucks.find(tr => tr.data.zone === zoneId) || null;
    }

    /* ===== Dashboard ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á (realtime) ===== */
    function recomputeDashboard() {
      let total = 0;
      let online = 0;
      let full = 0;
      let normal = 0;

      const NOW = Date.now();
      const ONLINE_TIMEOUT = 30000; // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå

      Object.values(dashboardState).forEach(zone => {
        total += zone.totalBins || 0;

        zone.macList.forEach(mac => {
          const info = binsLevelState[mac];
          if (!info) return;

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô
          const isOnline = (NOW - info.lastUpdate) <= ONLINE_TIMEOUT;

          if (isOnline) {
            online++;
            if (info.fillLevel >= 80) {
              full++;
            } else {
              normal++;
            }
          }
        });
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
      if (totalEl) totalEl.textContent = total ?? t('dashPlaceholder');
      fullEl.textContent = full ?? t('dashPlaceholder');
      midEl.textContent = online ?? t('dashPlaceholder');
      lowEl.textContent = normal ?? t('dashPlaceholder');
    }

    async function setupDashboardListeners() {
      dashboardUnsubs.forEach(fn => fn && fn());
      dashboardUnsubs = [];

      const zonesSnap = await fs.collection("zones").get();

      // 1Ô∏è‚É£ ‡∏î‡∏∂‡∏á bin_data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏µ‡πà‡∏ñ‡∏±‡∏á + mac ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
      zonesSnap.forEach(zDoc => {
        const zoneId = zDoc.id;
        dashboardState[zoneId] = {
          totalBins: 0,
          macList: [],
          levelByMac: {}
        };

        const unsub = fs.collection("smartbins")
          .doc(zoneId)
          .collection("bin_data")
          .onSnapshot(snap => {
            let count = 0;
            const macs = [];
            snap.forEach(doc => {
              const d = doc.data() || {};
              if (d.isHidden === true || d.deletedAt) return;
              if (!d.macAddress) return;
              count++;
              macs.push(d.macAddress);
            });
            dashboardState[zoneId].totalBins = count;
            dashboardState[zoneId].macList = macs;
            recomputeDashboard();
          });

        dashboardUnsubs.push(unsub);
      });
    }

    /* ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ ===== */
    function applyLanguage() {

      // ‚ùå ‡πÑ‡∏°‡πà set role ‡πÄ‡∏≠‡∏á
      // ‚úÖ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ AdminProfile / AdminUser ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£

      document.title = t('pageTitle_truck');
      if (window.AdminNav?.setLanguage) {
        window.AdminNav.setLanguage(currentLang);
      }
      if (window.AdminUser?.setLanguage) {
        window.AdminUser.setLanguage(currentLang);
      }
      if (window.AdminProfile?.setLanguage) {
        window.AdminProfile.setLanguage(currentLang);
      }

      document.getElementById('pageTitleHeading').textContent = t('mainTitle_truck');
      const subEl = document.getElementById('pageSubtitle');
      if(subEl) subEl.textContent = t('pageSubtitle_truck') || t('pageSubtitle') || "";
      if (loaderTextEl) loaderTextEl.textContent = t('loading');


      const truckIdLabelEl = document.getElementById('truckIdLabel');
      if (truckIdLabelEl) truckIdLabelEl.textContent = t('truckIdLabel');

      if (truckIdPreview) {
        truckIdPreview.placeholder = t('truckIdPlaceholder');
      }

      const sidebarTitleEl = document.getElementById('sidebarTitle');
      if (sidebarTitleEl) sidebarTitleEl.textContent = t('sidebarTitle');

      // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á
      document.getElementById('cardTotalTitle').textContent = t('cardTotal');
      document.getElementById('cardFullTitle').textContent = t('cardFull');
      document.getElementById('cardMidTitle').textContent = t('cardMid');
      document.getElementById('cardLowTitle').textContent = t('cardLow');

      // filter zone
      document.getElementById('zoneFilterLabel').textContent = t('zoneFilterLabel');
      if (zoneFilter.options.length > 0) {
        zoneFilter.options[0].textContent = `${t('zoneFilterAll')}`;
      }
      if(btnCreate){
        const label = t('createTruckBtn');
        btnCreate.innerHTML = `<span class="btnCreateLabel">+</span><span>${label}</span>`;
      }

      // usage
      document.getElementById('usageTitle').textContent = t('usageTitle');
      document.getElementById('usageHint').textContent = t('usageHint');
      const monthLabel = document.getElementById('monthSelectLabel');
      if (monthLabel) {
        monthLabel.textContent = t('monthSelectLabel');
      }
      document.getElementById('usageThDate').textContent = t('usageThDate');
      const truckTh = document.getElementById('usageThTruck');
      if (truckTh) truckTh.textContent = t('truckIdLabel');
      const driverTh = document.getElementById('usageThDriver');
      if (driverTh) driverTh.textContent = t('usageThDriver');
      document.getElementById('usageThStart').textContent = t('usageThStart');
      document.getElementById('usageThDuration').textContent = t('usageThDuration');

      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÇ‡∏ã‡∏ô
      const zoneTh = document.getElementById('usageThZone');
      if (zoneTh) zoneTh.textContent = t('usageThZone');

      const usageStartTh = document.getElementById('usageThStart');
      if (usageStartTh) usageStartTh.textContent = t('usageThStart');
      const usageEndTh = document.getElementById('usageThEnd');
      if (usageEndTh) usageEndTh.textContent = t('usageThEnd');
      const usageDurationTh = document.getElementById('usageThDuration');
      if (usageDurationTh) usageDurationTh.textContent = t('usageThDuration');
      const usageLatTh = document.getElementById('usageThLat');
      if (usageLatTh) usageLatTh.textContent = t('usageThLat');
      const usageLngTh = document.getElementById('usageThLng');
      if (usageLngTh) usageLngTh.textContent = t('usageThLng');

      // overlay ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ
      const createTitleEl = document.getElementById('createPanelTitle');
      const zoneSelectLabelEl = document.getElementById('zoneSelectLabel');
      if (createTitleEl) createTitleEl.textContent = t('createPanelTitle');
      if (zoneSelectLabelEl) zoneSelectLabelEl.textContent = t('zoneSelectLabel');
      if (btnSaveTruck) btnSaveTruck.textContent = t('saveTruckBtn');
      if (btnCancelCreate) btnCancelCreate.textContent = t('cancelTruckBtn');
      if (truckZoneSelect && truckZoneSelect.options.length > 0) {
        truckZoneSelect.options[0].textContent = t('selectZoneDefault');
      }

      if (!currentZoneFilter) {
        truckInfo.textContent = t('noZoneSelected');
      }

      // ‡∏õ‡∏£‡∏±‡∏ö popup ‡∏£‡∏ñ/‡∏ñ‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
      // Object.entries(truckMarkers).forEach(([id, m]) => {
      //   const isActive = !!truckActiveMap[id];
      //   m.bindPopup(isActive ? t('mapPopupTruckActive') : t('mapPopupTruckInactive'));
      // });
      updateTruckPopupsLanguage();
      updateTruckInfoPanel();
      updateUsageEmptyState();
    }

    function changeLanguage(lang) {
      if (window.SW_Translations && window.SW_Translations[lang]) {
        currentLang = lang;
        localStorage.setItem("sw_lang", lang);

        if (LangState && typeof LangState.setLang === "function") {
          LangState.setLang(lang);
        }

        // ‚úÖ highlight ‡∏†‡∏≤‡∏©‡∏≤‡πÉ‡∏ô dropdown
        syncLangMenuActive(lang);

        if (langSelect) langSelect.value = currentLang;
        applyLanguage();
        if (loaderTextEl) loaderTextEl.textContent = t('loading');
      }
    }

    if (langSelect) {
      langSelect.addEventListener("change", e => changeLanguage(e.target.value));
      langSelect.value = currentLang;
    }

    if (langIconBtn && langMenu) {
      langIconBtn.addEventListener("click", () => {
        langMenu.classList.toggle("show");
      });

      langMenu.addEventListener("click", e => {
        const btn = e.target.closest("button[data-lang]");
        if (!btn) return;
        changeLanguage(btn.dataset.lang);
        langMenu.classList.remove("show");
      });
    }

    if (LangState && typeof LangState.onChange === "function") {
      LangState.onChange(lang => {
        if (lang && lang !== currentLang) {
          currentLang = lang;
          if (langSelect) langSelect.value = lang;
          syncLangMenuActive(lang);
          applyLanguage();
        }
      });
    }

    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏†‡∏≤‡∏©‡∏≤ (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö sidebar ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ backdrop ‡πÅ‡∏•‡πâ‡∏ß)
    if (langMenu && langIconBtn) {
      document.addEventListener("click", e => {
        const clickedInLang = langMenu.contains(e.target) || langIconBtn.contains(e.target);
        if (!clickedInLang) langMenu.classList.remove("show");
      });
    }

    async function loadZonesForTruckForm() {
      truckZoneSelect.innerHTML = `<option value="">${t('selectZoneDefault')}</option>`;
      const snap = await fs.collection("zones").get();
      snap.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.data().name || doc.id;
        truckZoneSelect.appendChild(opt);
      });
    }

    async function generateTruckId(zoneId, zoneName) {
      // ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô (Yala -> Y)
      const Z = (zoneName || zoneId).charAt(0).toUpperCase();
      const prefix = `TRUCK_${Z}`;

      // üîé ‡∏´‡∏≤ truck ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ TRUCK_Y
      const snap = await fs.collection("trucks")
        .doc(zoneId)
        .collection("vehicles")
        .get();

      let max = 0;
      snap.forEach(doc => {
        const id = doc.id; // TRUCK_Y001
        const m = id.match(/(\d{3})$/);
        if (m) max = Math.max(max, parseInt(m[1], 10));
      });

      return prefix + String(max + 1).padStart(3, "0");
    }

    async function refreshTruckIdPreview() {
      const zoneId = truckZoneSelect.value;
      if (!zoneId) {
        truckIdPreview.value = "";
        return;
      }

      const zoneName =
        truckZoneSelect.options[truckZoneSelect.selectedIndex].text;

      const id = await generateTruckId(zoneId, zoneName);
      truckIdPreview.value = id;
    }

    truckZoneSelect.addEventListener("change", refreshTruckIdPreview);

    function openCreateOverlay() {
      applyLanguage();
      createOverlay.style.display = 'flex';
      createPanel.style.animation = 'none';
      void createPanel.offsetWidth;
      createPanel.style.animation = '';
      document.body.classList.add("overlay-open");
      // ensure consistent sizing
      createPanel.classList.add("compact");
      // hard override sizing (in case cached styles remain)
      createPanel.style.setProperty("width", "460px", "important");
      createPanel.style.setProperty("max-width", "92vw", "important");
      createPanel.style.setProperty("padding", "16px 18px 16px", "important");
      createPanel.style.setProperty("height", "auto", "important");
      createPanel.style.setProperty("max-height", "90vh", "important");
      document.querySelectorAll("#createPanel select, #createPanel input").forEach(el=>{
        el.style.setProperty("height","44px","important");
        el.style.setProperty("padding","10px 12px","important");
        el.style.setProperty("font-size","14px","important");
        el.style.setProperty("border-radius","12px","important");
      });
      const actions = document.querySelector("#createPanel .overlay-actions");
      if(actions){
        actions.style.setProperty("gap","10px","important");
        actions.style.setProperty("margin-top","12px","important");
      }
      document.querySelectorAll("#createPanel .overlay-actions button").forEach(btn=>{
        btn.style.setProperty("min-height","44px","important");
        btn.style.setProperty("padding","10px 16px","important");
        btn.style.setProperty("border-radius","12px","important");
      });
    }

    function closeCreateOverlay() {
      createOverlay.style.display = 'none';
      document.body.classList.remove("overlay-open");
    }

    btnCreate.addEventListener('click', async () => {
      openCreateOverlay();
      await loadZonesForTruckForm();
      applyLanguage();
    });

    btnCancelCreate.addEventListener('click', () => {
      closeCreateOverlay();
    });

    createOverlay.addEventListener('click', (e) => {
      if (e.target === createOverlay) {
        closeCreateOverlay();
      }
    });

    btnSaveTruck.addEventListener("click", async () => {
      const truckId = truckIdPreview.value;
      if (!truckId) {
        Swal.fire({
          icon: "warning",
          title: t('pleaseSelectZone'),
          confirmButtonText: "OK",
          customClass: {
            popup: "sw-popup"
          },
          didOpen: () => {
            const c = document.querySelector('.swal2-container');
            if (c) c.style.zIndex = 2000;
          }
        });
        return;
      }

      const zoneId = truckZoneSelect.value;
      const zoneName =
        truckZoneSelect.options[truckZoneSelect.selectedIndex].text;

      await fs
        .collection("trucks")
        .doc(zoneId)
        .collection("vehicles")
        .doc(truckId)
        .set({
          truckId,
          zone: zoneId,
          zoneName,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

      closeCreateOverlay();
      await loadTrucks();
    });

    /* ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô filter ===== */
    zoneFilter.addEventListener('change', () => {
      applyZoneFilter(zoneFilter.value || "");
    });


    window.addEventListener('beforeunload', () => {
      clearBinMarkers();
      clearTruckListenersAndMarkers();
      dashboardUnsubs.forEach(fn => fn && fn());
    });

    window.addEventListener('resize', () => {
      // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠ viewport ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
      setTimeout(() => {
        map.invalidateSize();
      }, 200);
    });

    const truckServerDeltaMap = {}; // truckId -> (serverLastUpdate - clientNow)
    const truckLastPosMap = {}; // truckId -> {lat,lng}

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Realtime ‡∏à‡∏≤‡∏Å driver_live ---
    function setupDriverLiveListener() {
      const liveRef = firebase.database().ref("driver_live");

      function handleDriverItem(driverKey, data) {
        if (!data) return;

        const truckId = data.truckId;
        const zoneFromRTDB = data.zoneId || data.zone || "";
        if (!truckId) return;

        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö delta (‡∏ó‡∏≥‡πÉ‡∏´‡πâ ticker ‡∏ß‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
        const lastUpdate =
          (typeof data.lastUpdate === "number") ? data.lastUpdate :
            (typeof data.updatedAt === "number") ? data.updatedAt :
              Date.now();

        truckServerDeltaMap[truckId] = lastUpdate - Date.now();

        // ====== ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ======
        if (truckId && zoneFromRTDB) {
          const today = new Date().toISOString().slice(0, 10);
          const warnKey = `${truckId}_${today}`;

          if (!warnedNoSchedule[warnKey]) {
            loadTodaySchedule(zoneFromRTDB).then(schedule => {
              const isWorking = data.isWorking === true || data.isworking === true;
              if (!schedule && isWorking) {
                warnedNoSchedule[warnKey] = true;
                Swal.fire({
                  icon: "warning",
                  title: t('noScheduleTitle'),
                  text: t('noScheduleText'),
                });
              }
            });
          }
        }

        const isActive = data.isWorking === true || data.isworking === true;
        truckActiveMap[truckId] = isActive;

        // sync zone ‡πÄ‡∏Ç‡πâ‡∏≤ trucks[] (‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å RTDB)
        const truckObj = trucks.find(tr => tr.id === truckId);
        if (zoneFromRTDB) {
          truckZoneMap[truckId] = zoneFromRTDB;
          if (truckObj) truckObj.data.zone = zoneFromRTDB;
        }

        // ‚úÖ ‡∏à‡∏≥‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏ï‡∏≠‡∏ô loadTrucks)
        if (typeof data.lat === "number" && typeof data.lng === "number") {
          truckLastPosMap[truckId] = { lat: data.lat, lng: data.lng };
        }

        // create/get marker (online)
        let marker = truckMarkers[truckId];
        if (!marker) {
          if (typeof data.lat !== "number" || typeof data.lng !== "number") return;
          marker = L.marker([data.lat, data.lng], { icon: buildTruckIcon(isActive) }).addTo(map);
          truckMarkers[truckId] = marker;
        }

        // update position
        if (typeof data.lat === "number" && typeof data.lng === "number") {
          marker.setLatLng([data.lat, data.lng]);
        }

        marker.setIcon(buildTruckIcon(isActive));
        updateTruckMarkerVisibility(truckId);

        const displayName = truckObj?.data?.name || data.truckName || data.truckId || truckId || "-";
        truckDisplayNameMap[truckId] = displayName;
        const popupHtml =
          `<b>${displayName}</b><br>` +
          (isActive ? t('truckActiveLabel') : t('truckInactiveLabel'));

        if (marker.getPopup()) marker.getPopup().setContent(popupHtml);
        else marker.bindPopup(popupHtml);

        updateLiveTimerInTable(truckId, data);
        updateUsageTableVisibility();
        updateTruckInfoPanel(); // ‡πÉ‡∏´‡πâ panel ‡∏ó‡∏±‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
      }

      liveRef.on("child_added", (snap) => handleDriverItem(snap.key, snap.val()));
      liveRef.on("child_changed", (snap) => handleDriverItem(snap.key, snap.val()));

      liveRef.on("child_removed", (snap) => {
        const data = snap.val() || {};
        const truckId = data.truckId;
        if (!truckId) return;

        truckActiveMap[truckId] = false;
        updateTruckMarkerVisibility(truckId);
        updateTruckInfoPanel();
        updateUsageTableVisibility();

        // ‡∏õ‡∏¥‡∏î live row ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
        const tr = usageBody.querySelector(`tr[data-truck="${truckId}"]`);
        if (tr && tr.dataset.live === "1") {
          tr.dataset.live = "0";
          const durEl = tr.querySelector(".dur");
          if (durEl) durEl.dataset.live = "0";
        }
      });
    }

    function startLiveDurationTicker() {
      if (window.__LIVE_DURATION_TICK__) return;

      window.__LIVE_DURATION_TICK__ = setInterval(() => {
        document.querySelectorAll('#usageBody tr[data-live="1"][data-source="rtdb"]').forEach(row => {
          const truckId = row.dataset.truck;
          const durEl = row.querySelector(".dur");
          if (!durEl) return;

          // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á dataset ‡πÅ‡∏•‡∏∞ attribute ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤
          const startMs = Number(durEl.dataset.liveStartMs || durEl.getAttribute("data-live-start-ms") || "0");
          const baseSec = Number(durEl.dataset.baseSec || durEl.getAttribute("data-base-sec") || "0");
          if (!startMs) return;

          // ‚úÖ ‡πÉ‡∏ä‡πâ delta ‡∏ó‡∏≥‡πÉ‡∏´‡πâ "‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≠" ‡∏≠‡∏¥‡∏á RTDB ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          const delta = truckServerDeltaMap[truckId] || 0;
          const nowAdjusted = Date.now() + delta;

          const totalMs = baseSec * 1000 + Math.max(0, nowAdjusted - startMs);
          durEl.textContent = formatDurationMs(totalMs);
        });
      }, 1000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function updateLiveTimerInTable(truckId, data) {
      console.log("üßæ updateLiveTimerInTable", {
        truckId,
        startAt: data.startAt,
        isWorking: data.isWorking,
        isworking: data.isworking,
        isFinished: data.isFinished,
        finishedAt: data.finishedAt
      });

      const zoneFromRTDB = data.zoneId || data.zone || "";
      const zoneFromFS = trucks.find(t => t.id === truckId)?.data?.zone || "";
      const zoneResolved = zoneFromRTDB || zoneFromFS || "";

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏ñ‡πÇ‡∏ã‡∏ô‡∏≠‡∏∑‡πà‡∏ô
      if (currentZoneFilter && zoneResolved !== currentZoneFilter) return;

      const tbody = usageBody;
      let row = tbody.querySelector(`tr[data-truck="${truckId}"]`);

      const working = data.isWorking === true || data.isworking === true;
      const driverName = data.driverName || data.driver || "";

      let startMs =
        (typeof data.startAt === "number") ? data.startAt :
          (typeof data.lastStartAt === "number") ? data.lastStartAt :
            (typeof data.startAtMillis === "number") ? data.startAtMillis :
              null;

      // ‚úÖ ‡∏ñ‡πâ‡∏≤ RTDB ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á startAt ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
      if (!startMs && row && row.dataset.lastStartAt) {
        startMs = Number(row.dataset.lastStartAt);
      }

      // ‚úÖ fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö live: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ startAt ‡πÅ‡∏ï‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ lastUpdate ‡πÅ‡∏ó‡∏ô
      if (!startMs && working) {
        const fallbackMs =
          (typeof data.lastUpdate === "number") ? data.lastUpdate :
            (typeof data.updatedAt === "number") ? data.updatedAt :
              Date.now();
        startMs = fallbackMs;
      }

      // ‚úÖ fallback ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ finishedAt + baseElapsedSec ‡∏Å‡πá‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏≤ start ‡πÑ‡∏î‡πâ
      if (!startMs && typeof data.finishedAt === "number" && typeof data.baseElapsedSec === "number") {
        startMs = data.finishedAt - (data.baseElapsedSec * 1000);
      }

      if (!startMs) {
        console.warn("‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ startAt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö", truckId, data);
        return;
      }

        // ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ======
        if (!row) {
          row = document.createElement("tr");
          row.dataset.truck = truckId;
          row.dataset.live = "1";
        row.dataset.source = "rtdb";
        row.dataset.persisted = "0";
        row.dataset.lastStartAt = String(startMs);

        const baseSecInit =
          (typeof data.baseElapsedSec === "number") ? data.baseElapsedSec : 0;

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÇ‡∏ã‡∏ô
        row.innerHTML = `
  <td class="truck left">${truckId}</td>
  <td class="driver left">${driverName || t('dashPlaceholder')}</td>
  <td class="date left">${new Date().toLocaleDateString()}</td>
  <td class="zone center"><span class="badge-zone">${zoneResolved || t('dashPlaceholder')}</span></td>
  <td class="start center">${new Date(startMs).toLocaleTimeString()}</td>

  <td class="dur center"
      data-live="1"
      data-live-start-ms="${startMs}"
      data-base-sec="${baseSecInit}">
    ${formatDurationMs(baseSecInit * 1000)}
  </td>
`;

        // ‡∏•‡∏ö placeholder row ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
        const firstRow = tbody.querySelector("tr");
        if (firstRow && !firstRow.dataset.truck) firstRow.remove();

        tbody.appendChild(row);
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
      const truckCell = row?.querySelector?.("td.truck");
      if (truckCell) truckCell.textContent = truckId;
      const driverCell = row?.querySelector?.("td.driver");
      if (driverCell) driverCell.textContent = driverName || t('dashPlaceholder');

      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ RTDB ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
      row.dataset.zone = zoneResolved || "";
      const zoneCell = row.querySelector(".zone");
      if (zoneCell) zoneCell.innerHTML = `<span class="badge-zone">${zoneResolved || t('dashPlaceholder')}</span>`;

      // ‡∏ñ‡πâ‡∏≤ startAt ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà) ‚Üí ‡∏õ‡∏•‡∏î persisted
      if (row.dataset.lastStartAt !== String(startMs)) {
        row.dataset.persisted = "0";
        row.dataset.lastStartAt = String(startMs);
      }

      // ====== ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ======
      if (working) {
        row.dataset.live = "1";
        row.dataset.source = "rtdb";
        row.dataset.persisted = "0";

        const baseSec =
          (typeof data.baseElapsedSec === "number") ? data.baseElapsedSec : 0;

        const durEl = row.querySelector(".dur");
        durEl.dataset.live = "1";
        durEl.dataset.liveStartMs = String(startMs);
        durEl.dataset.baseSec = String(baseSec);

        return;
      }

      // ====== ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ======
      const endMs =
        (typeof data.finishedAt === "number") ? data.finishedAt :
          (typeof data.stoppedAt === "number") ? data.stoppedAt :
            Date.now();

      const finishedFlag =
        data.isFinished === true ||
        data.isFinished === "true" ||
        (typeof data.finishedAt === "number");

      if (!finishedFlag) {
        console.log("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏à‡∏£‡∏¥‡∏á (skip persist)", truckId, data);
        return;
      }

      const baseSec =
        (typeof data.baseElapsedSec === "number") ? data.baseElapsedSec :
          (typeof data.totalSeconds === "number") ? data.totalSeconds :
            null;

      const durationSec = baseSec !== null
        ? baseSec
        : Math.max(0, Math.round((endMs - startMs) / 1000));

      const endLat = (typeof data.lat === "number") ? data.lat : null;
      const endLng = (typeof data.lng === "number") ? data.lng : null;

      // ‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
      if (row.dataset.persisted !== "1") {
        row.dataset.persisted = "1";

        const zoneId = zoneResolved;
        if (!zoneId) {
          console.warn("‚õî zoneId ‡∏ß‡πà‡∏≤‡∏á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", data);
        } else {
          const dateKey = new Date().toISOString().slice(0, 10);

          const docRef = fs.collection("trucks")
            .doc(zoneId)
            .collection("vehicles")
            .doc(truckId)
            .collection("truck_operating_time")
            .doc(dateKey);

          docRef.set({
            driverId: data.driverId || null,
            driverName: data.driverName || null,
            truckId: truckId,
            zone: zoneId,
            zoneName: zoneId,

            lat: endLat,
            lng: endLng,

            startAt: firebase.firestore.Timestamp.fromMillis(startMs),
            endAt: firebase.firestore.Timestamp.fromMillis(endMs),

            totalSeconds: durationSec,

            isFinished: true,
            finishedAt: firebase.firestore.Timestamp.fromMillis(endMs),

            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true })
            .then(() => console.log("‚úÖ persisted stop:", truckId, dateKey))
            .catch(err => console.error("‚ùå persist stop failed:", err));
        }
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      row.dataset.live = "0";
      const durEl = row.querySelector(".dur");
      if (durEl) {
        durEl.dataset.live = "0";
        durEl.textContent = formatDurationMs(durationSec * 1000);
      }
    }

    function updateUsageTableVisibility() {
      const searchInput = document.getElementById("usageSearch");
      const term = (searchInput?.value || "").toLowerCase().trim();
      document.querySelectorAll('#usageBody tr[data-truck]').forEach(tr => {
        const truckId = tr.dataset.truck;

        const fromFS = trucks.find(t => t.id === truckId)?.data?.zone || "";
        const fromRow = tr.dataset.zone || tr.querySelector(".zone")?.textContent || "";
        const zoneResolved = fromFS || fromRow || "";
        if (!tr.dataset.zone && zoneResolved) tr.dataset.zone = zoneResolved;

        const isActive = !!truckActiveMap[truckId];
        let visible = isActive;

        if (visible && currentZoneFilter) {
          visible = (zoneResolved === currentZoneFilter);
        }

        if (visible && term) {
          visible = tr.textContent.toLowerCase().includes(term);
        }

        tr.style.display = visible ? "" : "none";
      });
      updateUsageEmptyState();
    }

    function updateUsageEmptyState() {
  if (!usageBody) return;

  const rows = Array.from(usageBody.querySelectorAll('tr[data-truck]'));
  const visibleRows = rows.filter(tr => tr.style.display !== "none");
  const nonDataRows = Array.from(usageBody.querySelectorAll('tr:not([data-truck])'));

  if (visibleRows.length > 0) {
    nonDataRows.forEach(tr => tr.remove());
    return;
  }

  const placeholder = usageBody.querySelector('tr[data-empty="1"]');
  if (placeholder) {
    const cell = placeholder.querySelector("td");
    if (cell) cell.textContent = t('noData');
    return;
  }

  nonDataRows.forEach(tr => tr.remove());
  const tr = document.createElement("tr");
  tr.dataset.empty = "1";
  tr.innerHTML = `<td colspan="6" class="muted">${t('noData')}</td>`;
  usageBody.appendChild(tr);
}

    function setupUsageSearch(){
      const searchInput = document.getElementById("usageSearch");
      if(!searchInput) return;
      searchInput.addEventListener("keyup", ()=>{
        updateUsageTableVisibility();
      });
    }

    function setupUsageRowClick(){
      if (!usageBody) return;
      usageBody.addEventListener("click", (e) => {
        const row = e.target.closest('tr[data-truck]');
        if (!row) return;
        focusTruckOnMap(row.dataset.truck);
      });
    }

    function startNoScheduleDailyReset() {
      if (window.__LIVE_TICKER__) return;
      window.__LIVE_TICKER__ = setInterval(() => {
        const today = new Date().toISOString().slice(0, 10);
        Object.keys(warnedNoSchedule).forEach(k => {
          if (!k.endsWith(today)) delete warnedNoSchedule[k];
        });
      }, 60 * 1000);

    }
    let shownOfflineAlert = false;

    firebase.firestore().onSnapshotsInSync(() => {
      // Firestore ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß
      shownOfflineAlert = false;
    });

    (async function init() {
      if (langMenu) {
        document
          .querySelectorAll("#langMenu button")
          .forEach(b => b.classList.toggle("active", b.dataset.lang === currentLang));
      }

      if (langSelect) langSelect.value = currentLang;

      showPageLoader();
      try{
        await loadZonesForFilter();
        await loadTrucks();
        applyZoneFilter(currentZoneFilter);
        await setupDashboardListeners(); // ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö realtime ‡πÅ‡∏ó‡∏ô updateDashboard ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        startBinStatusTicker();
        setupDriverLiveListener();
        startNoScheduleDailyReset();
        startLiveDurationTicker();
        // setupUsageSearch();
        setupUsageRowClick();
        applyLanguage();
      }catch(err){
        console.error("INIT ERROR:", err);
      } finally {
        hidePageLoader();
      }
      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
    })();
  </script>
</body>

</html>
