<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</title>

  <link rel="stylesheet" href="a_style.css">
  <link rel="stylesheet" href="admin-shell.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

  <script src="../Login/auth.js"></script>
  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>
  <script src="admin-lang.js"></script>
  <script src="admin-shell.js" defer></script>
  <script src="admin-user.js" defer></script>
  <script src="admin-nav.js" defer></script>
  <script>
    let currentUser = null;
    const currentUserPromise = window.SWAuth.requireAuth([0])
      .then(user => {
        currentUser = user;
        window.currentUser = user;
        return user;
      })
      .catch(err => {
        console.error("Auth error:", err);
        return null;
      });
  </script>

  <style>
    :root{
      --bg:#f3f6fb;            /* ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;

      /* ‚úÖ ‡∏ò‡∏µ‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß-‡∏ü‡πâ‡∏≤ */
      --primary:#10b981;
      --primary-dark:#047857;
      --accent:#0ea5e9;

      --primary-soft: rgba(16,185,129,.12);
      --accent-soft: rgba(14,165,233,.12);

      --border:#e6ebf3;
      --shadow: 0 10px 24px rgba(17,24,39,.08);

      --header-h:72px;
      --sidebar-w:260px;
      --side-pad-x:6px;
    }

    *{ box-sizing:border-box; font-family:"Prompt",sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    /* ===== HEADER ===== */
    .top-header{
      position:fixed; top:0; left:0; right:0;
      height:var(--header-h);
      background:var(--surface);
      border-bottom:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(17,24,39,.08);
      z-index:1200;
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 18px;
      gap:12px;
    }

    .brand-left{ display:flex; align-items:center; gap:10px; min-width: 220px; }

    .brand-mark{
      width:40px; height:40px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(16,185,129,.18), rgba(14,165,233,.18));
      border: 1px solid rgba(16,185,129,.22);
      display:grid; place-items:center;
      color: var(--primary-dark);
      font-size:20px; font-weight:900;
    }

    .brand-name{
      font-size:22px;
      font-weight:900;
      letter-spacing:-0.2px;
      white-space:nowrap;
      background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;
      display:block;
    }

    .header-right{ display:flex; align-items:center; gap:10px; }

    /* ‡∏†‡∏≤‡∏©‡∏≤: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏™‡∏µ‡∏î‡∏≥ */
    .icon-btn{
      width:58px; height:58px;
      min-height:58px;
      border-radius:18px;
      border:1px solid var(--border);
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
      transition: transform .2s, border-color .2s, box-shadow .2s;
    }
    .icon-btn:active{ transform: scale(0.96); }
    .icon-btn:hover{
      border-color: rgba(0,0,0,.22);
      box-shadow: 0 14px 28px rgba(17,24,39,.09);
    }
    .icon-btn i{
      font-size:28px;
      color:#000;
      opacity: 1;
    }

    .lang-menu{
      position:absolute;
      right:0;
      top:60px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow);
      display:none;
      overflow:hidden;
      min-width:120px; /* ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á */
      z-index:1500;
    }
    .lang-menu button{
      width:100%;
      border:none;
      background:transparent;
      padding:12px 14px;
      text-align:left;
      cursor:pointer;
      font-weight:800;
      color: var(--text);
      white-space: nowrap;
    }
    .lang-menu button:hover{ background:#f8fafc; }

    /* Override language button/menu to match login style */
    .lang-switcher .icon-btn{
      width:44px; height:44px; min-height:44px;
      border-radius:50%;
      border:1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(15,23,42,0.12);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .lang-switcher .icon-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.16);
    }
    .lang-switcher .icon-btn i{ font-size:22px; color:#0f172a; }

    .lang-menu{
      top:54px;
      border:1px solid rgba(226,232,240,0.9);
      border-radius:18px;
      box-shadow: 0 14px 30px rgba(15,23,42,0.18);
      display:none;
      flex-direction: column;
      gap: 6px;
      min-width:190px;
      padding: 8px;
    }
    .lang-menu.show{ display:flex; }
    .lang-menu button{
      padding:10px 12px;
      font-weight:600;
      color:#0f172a;
      border-radius:12px;
      font-size:15px;
    }
    .lang-menu button:hover{ background:#f1f5f9; }
    .lang-menu button.active{ background:#e0f2fe; color: var(--accent, #0ea5e9); font-weight:700; }

    /* ===== USER (HEADER) ===== */
    .header-user{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 18px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      height:52px;
      min-height:52px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
    }
    .user-avatar{
      width:36px; height:36px;
      border-radius:14px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#f8fafc;
    }
    .user-meta{ line-height:1.1; }
    .user-name{ font-weight:900; font-size:13px; }
    .user-role{ font-weight:800; font-size:12px; color:var(--muted); }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */
    .menu-toggle{
      display:none;
      width:48px; height:48px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
      transition: transform .2s;
    }
    .menu-toggle:active{ transform: scale(.96); }
    .menu-toggle i{ font-size:22px; color: #000; }

    /* ===== Sidebar ===== */
    .sidebar{
      position:fixed;
      top:var(--header-h);
      left:0;
      width:var(--sidebar-w);
      height: calc(100vh - var(--header-h));
      background: var(--surface);
      color: var(--text);
      border-right:1px solid var(--border);
      padding: 14px 14px 16px;
      display:flex;
      flex-direction:column;
      z-index:1100;
    }

    .sidebar-user{
      display:none;
      gap:10px;
      align-items:center;
      padding: 12px 12px;
      margin: 4px var(--side-pad-x) 10px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
    }
    .sidebar-user .user-avatar{ width:42px; height:42px; border-radius:16px; }
    .sidebar-user .user-name{
      font-size:14px;
      color: var(--text);
    }
    .sidebar-user .user-role{ font-size:12px; }

    .menu{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 10px var(--side-pad-x);
      margin:0;
      flex:1;
      overflow:auto;
    }

    /* ===== LOGOUT ===== */
    .sw-logout-slot{ padding: 0 var(--side-pad-x) 6px; }
    .sw-logout-slot, .sw-logout-slot *{ max-width: none !important; inline-size: auto !important; }
    .sw-logout-slot > *{ display:block !important; width:100% !important; }
    .sw-logout-slot button,
    .sw-logout-slot a,
    .sw-logout-slot .sw-logout-btn{
      width:auto !important;
      min-width:220px !important;
      max-width:245px !important;
      display:flex !important;
      align-items:center !important;
      justify-content:center !important;
      min-height:44px !important; /* ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
      border-radius: 12px !important;
      box-sizing: border-box !important;
      margin: 0 auto !important; /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á */
      padding: 12px 18px !important; /* ‡∏•‡∏î padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
      gap: 10px;
      font-weight: 900 !important;
      font-size: 15px !important;
      text-align: center !important;
    }
    .sw-logout-btn{
      background:#dc2626 !important;
      color:#fff !important;
      border:1px solid rgba(220,38,38,.18) !important;
      box-shadow: 0 10px 18px rgba(220,38,38,.16) !important;
    }

    /* ===== Main ===== */
    main{
      padding-top: 26px;
      margin: 0;
      width: 100%;
      padding-left: 28px;
      padding-right: 28px;
      padding-bottom: 30px;
      min-height: 100vh;
    }

    /* ===== Page head ===== */
    .page-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .page-head-left{ display:flex; flex-direction:column; }
    .page-head-right{ display:flex; align-items:flex-end; justify-content:flex-end; min-width: 240px; }

    .page-title{ margin:0; font-size: 44px; font-weight:900; letter-spacing:-0.8px; color:#1f2937; }
    .page-sub{ margin: 6px 0 0; color: var(--muted); font-weight:800; font-size:18px; }

    select, input[type="text"]{
      min-height:44px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      box-shadow: 0 10px 18px rgba(17, 24, 39, 0.02);
    }
    select:focus, input[type="text"]:focus{
      outline: 2px solid rgba(14,165,233,0.25);
      border-color: rgba(14,165,233,0.55);
      outline-offset: 2px;
    }

    #timeFilter{
      width: 340px;
      max-width: 42vw;
      height: 48px;
      border-radius: 16px;
      font-weight: 800;
    }

    /* ===== Detail top row ===== */
    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 0 0 18px;
      flex-wrap: wrap;
    }

    /* ‚úÖ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á "‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö/‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á" ‡∏Å‡∏±‡∏ö "‡∏Å‡∏£‡∏≤‡∏ü" ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
    body.show-detail .header-row.report-toolbar{
      margin-bottom: 34px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
    }
    /* ‡∏î‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÉ‡∏à */
    body.show-detail #detailSection .card:first-child{
      margin-top: 10px;
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
    }

    .ghost{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 800;
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:44px;
      box-shadow: 0 10px 18px rgba(17,24,39,.02);
    }

    #sectionTitle{
      display:none;
      margin:0;
      font-size:20px;
      font-weight:900;
      line-height:1.1;
    }
    body.show-detail #sectionTitle{ display:block; }
    body.show-detail .page-head{ margin-bottom: 10px !important; }
    body.show-detail .page-head-right{ display:none !important; }

    #detailControls{
      display:none;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    body.show-detail #detailControls{ display:flex; }

    #timeFilterDetail, #zoneFilter{
      height:44px;
      min-height:44px;
      border-radius:14px;
      font-weight:800;
      font-size:13px;
      width:220px;
      max-width: 30vw;
    }

    /* ===== Summary cards ===== */
    .cards-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 22px;
      margin-bottom: 18px;
    }

    .summary-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 22px;
      padding: 26px 26px;
      box-shadow: 0 12px 26px rgba(17,24,39,.08);
      cursor:pointer;
      transition: transform .16s ease, box-shadow .16s ease;
      display:flex;
      align-items:center;
      gap:18px;
      min-height: 110px;
      position:relative;
      z-index:5;
      overflow:hidden;
    }
    .summary-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 38px rgba(17,24,39,.12);
    }

    .card-icon-box{
      width:66px; height:66px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(16,185,129,.12), rgba(14,165,233,.12));
      display:grid;
      place-items:center;
      color: var(--primary-dark);
      font-size: 28px;
      flex-shrink:0;
      border: 1px solid rgba(16,185,129,.14);
    }
    .card-body{ display:flex; flex-direction:column; gap:8px; }
    .card-label{ font-size:20px; font-weight:900; color:#6b7280; }
    .big-stat{ font-size:56px; font-weight:900; line-height: 1; }
    .sub-stat{ font-size:18px; font-weight:900; color:#6b7280; display:flex; align-items:center; gap:10px; }

    .summary-card::after{
      content: "\ea6e";
      font-family: "remixicon";
      position:absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: rgba(14,165,233,.12);
      color: var(--accent);
      display:grid;
      place-items:center;
      font-size: 22px;
      font-weight: 900;
      opacity: .95;
      transition: transform .16s ease, background .16s ease;
      pointer-events:none;
    }
    .summary-card:hover::after{
      transform: translateY(-50%) translateX(2px);
      background: rgba(14,165,233,.18);
    }
    .summary-card .card-body{ padding-right: 56px; }

    #overviewSection, #summaryCardsGrid, .content, .content > div{
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* ===== Cards ===== */
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
      margin-bottom: 16px;
    }
    .chart-wrapper{ height: 380px; width:100%; position:relative; }

    /* ‚úÖ table-card: ‡πÅ‡∏Å‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°/‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô + ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô scroll-x ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ table */
    .card.table-card{
      padding: 0;
      overflow: hidden;
      border-radius: 18px;
    }
    .card.table-card .table-toolbar{
      padding: 18px 18px 12px 18px;
      margin-bottom: 0;
      background:#fff;
      position: sticky; /* ‚úÖ ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ô card */
      top: 0;
      z-index: 5;
      border-bottom: 1px solid var(--border);
    }

    .table-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .search-box{ margin-left:auto; width: 280px; max-width: 100%; }
    .search-box input{
      width:100%;
      height:44px;
      min-height:44px;
      border-radius:16px;
      font-size:13px;
      font-weight:800;
      padding:10px 12px;
    }

    /* ‚úÖ ‡∏ï‡∏±‡∏ß wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ */
    .table-scroll{
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-top: 0;
    }
    .table-scroll::-webkit-scrollbar{ height: 10px; }
    .table-scroll::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.15); border-radius: 999px; }

    /* ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    table{
      width:100%;
      min-width: 920px; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ö‡∏µ‡∏ö‡∏à‡∏ô‡∏´‡∏≤‡∏¢ */
      border-collapse: collapse;
      border-spacing: 0;
      font-size:14px;
      margin-top: -1px; /* ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ä‡∏¥‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô */
    }

    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      text-align: center;
      white-space: nowrap; /* ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    }
    thead th{
      background:#f8fafc;
      color:#374151;
      font-weight: 800;
      font-size: 13px;
      line-height: 1.2;
      padding-top: 14px;
      padding-bottom: 14px;
      position: sticky; /* ‚úÖ ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á */
      top: 0;
      z-index: 2;
    }
    /* ‚úÖ ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á */
    .card.table-card thead{
      background:#f8fafc;
    }
    .card.table-card thead th{
      top: -1px;
    }

    thead th:first-child,
    tbody td:first-child{ text-align:left; }

    tbody tr:hover{ background:#f8fafc; }

    .badge-zone{
      padding:6px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(16,185,129,.12), rgba(14,165,233,.12));
      color: var(--primary-dark);
      font-weight: 900;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 90px;
      border: 1px solid rgba(16,185,129,.14);
    }
    .badge-area{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:6px 10px;
      margin:2px;
      border-radius: 999px;
      background: rgba(14,165,233,.10);
      color: #075985;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(14,165,233,.16);
    }

    /* Overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Drawer */
    .drawer-overlay{
      position: fixed;
      left:0; right:0;
      top: var(--header-h);
      height: calc(100vh - var(--header-h));
      background: rgba(15,23,42,.35);
      backdrop-filter: blur(2px);
      z-index: 1050;
      display: none;
    }
    .drawer-overlay.show{ display:block; }

    /* ===== Responsive (Mobile) ===== */
    @media (max-width: 980px){
      .menu-toggle{ display:inline-flex; }
      #profileBoxTop{ display:none; }

      main{
        margin-left:0;
        width:100%;
        padding-left: 16px;
        padding-right: 16px;
        padding-bottom: 28px;
      }
      .cards-grid{ grid-template-columns: 1fr; }
      .page-title{ font-size: 34px; }
      .page-head{ flex-direction:column; align-items:flex-start; }
      .page-head-right{ width:100%; }
      #timeFilter{ width:100%; max-width:100%; }

      #detailControls{ width:100%; justify-content:flex-start; }
      #timeFilterDetail, #zoneFilter{ width:100%; max-width:100%; }

      /* ‚úÖ ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
      body.show-detail .header-row.report-toolbar{ margin-bottom: 18px !important; }

      /* Drawer */
      .sidebar{
        top: var(--header-h);
        height: calc(100vh - var(--header-h));
        transform: translateX(-105%);
        transition: transform .25s ease;
        z-index: 1100;
        box-shadow: 0 18px 50px rgba(0,0,0,.18);
        border-right: 1px solid rgba(230,235,243,.95);
      }
      .sidebar.show{ transform: translateX(0); }
      .sidebar-user{ display:flex; }

      /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ */
      .brand-mark{ display:none; }
      .brand-name{
        display:block !important;
        font-size:18px;
        font-weight:900;
        letter-spacing:-0.2px;
        white-space:nowrap;
      }

      /* ‚úÖ ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà) */
      .card.table-card .table-toolbar{
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 6;
      }
      .search-box{ width:100%; }
    }

    @media (max-width: 380px){
      .brand-name{ font-size:16px; }
    }
  </style>
</head>

<body data-active-nav="report">
  <div id="pageLoader" class="shell-loader">
    <div class="loader-box">
      <div class="loader-spinner"></div>
      <div class="loader-text" id="loaderText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
  </div>

  <main>
    <div class="page-head">
      <div class="page-head-left">
        <h1 class="page-title" id="pageTitleHeading">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h1>
        <p class="page-sub" id="pageSubtitle">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</p>
      </div>

      <div class="page-head-right">
        <select id="timeFilter">
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="week">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
          <option value="month">30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
          <option value="year">1 ‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
    </div>

    <div class="content">
      <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° class report-toolbar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü -->
      <div class="header-row report-toolbar">
        <div class="header-left">
          <button id="btnBack" class="ghost" style="display:none" onclick="goBackToOverview()">
            <i class="ri-arrow-left-line"></i> <span id="backText">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
          </button>
          <h3 id="sectionTitle" aria-hidden="true"></h3>
        </div>

        <div class="detail-controls" id="detailControls">
          <select id="timeFilterDetail" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="week">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="month">30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="year">1 ‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
          </select>

          <select id="zoneFilter" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          </select>
        </div>
      </div>

      <div id="overviewSection">
        <div class="cards-grid" id="summaryCardsGrid"></div>
      </div>

      <div id="detailSection" style="display:none;">
        <div class="card">
          <div class="chart-wrapper">
            <canvas id="detailChart"></canvas>
          </div>
        </div>

        <div class="card table-card">
          <div class="table-toolbar">
            <h4 id="tableTitle" style="margin:0; font-size:18px; font-weight:900;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h4>
            <div class="search-box">
              <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...">
            </div>
          </div>

          <div class="table-scroll">
            <table>
              <thead></thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA9SQW3iUwZWCgeG6eOYvvMU5g2hb_Zlrw",
      authDomain: "smartwaste2568-1d792.firebaseapp.com",
      databaseURL: "https://smartwaste2568-1d792-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartwaste2568-1d792",
      storageBucket: "smartwaste2568-1d792.firebasestorage.app",
      messagingSenderId: "1041339993312",
      appId: "1:1041339993312:web:65b26ea83dcbf4f8b29485",
      measurementId: "G-FV5TEPVZWN"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Language
    const langIconBtn = document.getElementById("langIconBtn");
    const langMenu = document.getElementById("langMenu");
    const syncLangMenuActive = (lang) => {
      if (!langMenu || !lang) return;
      langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });
    };
    function toggleLangMenu(show){
      if(typeof show === "boolean") langMenu.style.display = show ? "block" : "none";
      else langMenu.style.display = (langMenu.style.display === "block") ? "none" : "block";
    }
    if(langIconBtn && langMenu){
      langIconBtn.addEventListener("click", ()=> toggleLangMenu());
      langMenu.addEventListener("click", e=>{
        const btn = e.target.closest("button[data-lang]");
        if(!btn) return;
        const lang = btn.dataset.lang;
        if(window.AdminLang) window.AdminLang.setLang(lang);
        else changeLanguage(lang);
        syncLangMenuActive(lang);
        toggleLangMenu(false);
      });
      document.addEventListener("click", (e)=>{
        const inMenu = langMenu.contains(e.target) || langIconBtn.contains(e.target);
        if(!inMenu) toggleLangMenu(false);
      });
    }

    const pageLoader = document.getElementById("pageLoader");
    const loaderTextEl = document.getElementById("loaderText");
    const timeFilterSelect = document.getElementById("timeFilter");
    const timeFilterDetail = document.getElementById("timeFilterDetail");
    const zoneFilterSelect = document.getElementById("zoneFilter");
    const searchInput = document.getElementById("searchInput");

    const overviewSection = document.getElementById("overviewSection");
    const detailSection = document.getElementById("detailSection");
    const summaryCardsGrid = document.getElementById("summaryCardsGrid");
    const btnBack = document.getElementById("btnBack");
    const sectionTitle = document.getElementById("sectionTitle");

    Chart.defaults.font.family = "'Prompt', sans-serif";
    Chart.defaults.color = '#64748b';
    Chart.defaults.maintainAspectRatio = false;

    function showLoader(text){
      if(text && loaderTextEl) loaderTextEl.textContent = text;
      if(pageLoader) pageLoader.classList.add("show");
    }
    function hideLoader(){
      if(pageLoader) pageLoader.classList.remove("show");
    }

    const ctxDetail = document.getElementById("detailChart").getContext("2d");
    let detailChartInstance = null;

    let cachedZones = [];
    let globalLastData = {};
    let globalAllData = null;
    let prefetchingAll = false;
    let currentTableRows = [];
    let originalTableRows = [];
    let latestRenderId = 0;

    let currentTimeFilter = localStorage.getItem("sw_report_time_filter") || "all";
    if(currentTimeFilter === "day"){
      currentTimeFilter = "all";
      localStorage.setItem("sw_report_time_filter","all");
    }
    timeFilterSelect.value = currentTimeFilter;
    timeFilterDetail.value = currentTimeFilter;

    let currentView = "overview";
    let currentDetailType = null;

    const translations = {
      th: {
        pageTitle: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á",
        subtitle: "‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á",
        loaderText: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...",
        backBtn: "‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö",
        cardBinTitle: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏Ç‡∏¢‡∏∞",
        cardTruckTitle: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏ñ",
        unitTimes: "‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
        unitMinutes: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
        detailBinTitle: "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏Ç‡∏¢‡∏∞",
        detailTruckTitle: "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
        tableTitle: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        thDate: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤",
        thZone: "‡πÄ‡∏Ç‡∏ï",
        thArea: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
        thBinId: "‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏±‡∏á",
        thTruckId: "‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ",
        thFillPercent: "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏¢‡∏∞ (%)",
        thWeightGram: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏¢‡∏∞ (‡∏Å‡∏£‡∏±‡∏°)",
        timeAll: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        timeWeek: "7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤",
        timeMonth: "30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤",
        timeYear: "1 ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤",
        zoneAll: "üìç ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        searchPlaceholder: "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤, ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...",
        tableNoData: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        unknownArea: "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà",
        yAxisHours: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô(‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)",
        yAxisBinEmpties: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏ñ‡∏±‡∏á(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)"
      },
      en:
 {
        pageTitle: "Reports",
        subtitle: "View historical operations data",
        loaderText: "Loading...",
        backBtn: "Back",
        cardBinTitle: "Total Bin Empties",
        cardTruckTitle: "Total Truck Runs",
        unitTimes: "times",
        unitMinutes: "operating time",
        detailBinTitle: "Bin Empties Stats",
        detailTruckTitle: "Operating Time Stats",
        tableTitle: "Data Records",
        thDate: "Date/Time",
        thZone: "Zone",
        thArea: "Assigned Areas",
        thBinId: "Bin ID",
        thTruckId: "Truck ID",
        thFillPercent: "Waste Volume (%)",
        thWeightGram: "Waste Weight (g)",
        timeAll: "All Time",
        timeWeek: "Last 7 Days",
        timeMonth: "Last 30 Days",
        timeYear: "Last Year",
        zoneAll: "üìç All Zones",
        searchPlaceholder: "üîç Search Date/Time, Truck ID, Area...",
        tableNoData: "No data available",
        unknownArea: "Unspecified",
        yAxisHours: "Operating Time (hours)",
        yAxisBinEmpties: "Bin Empties (times)"
      },
      ms: {
        pageTitle: "Laporan",
        subtitle: "Lihat data operasi lepas",
        loaderText: "Memuatkan...",
        backBtn: "Kembali",
        cardBinTitle: "Jumlah Pengosongan",
        cardTruckTitle: "Jumlah Larian Lori",
        unitTimes: "kali",
        unitMinutes: "masa operasi",
        detailBinTitle: "Statistik Pengosongan",
        detailTruckTitle: "Statistik Masa Pemanduan",
        tableTitle: "Rekod Data",
        thDate: "Tarikh/Masa",
        thZone: "Zon",
        thArea: "Kawasan",
        thBinId: "ID Tong",
        thTruckId: "ID Lori",
        thFillPercent: "Jumlah Sampah (%)",
        thWeightGram: "Berat Sampah (g)",
        timeAll: "Semua Masa",
        timeWeek: "7 Hari Terakhir",
        timeMonth: "30 Hari Terakhir",
        timeYear: "Tahun Terkini",
        zoneAll: "üìç Semua Zon",
        searchPlaceholder: "üîç Cari Tarikh/Masa, ID Lori, Kawasan...",
        tableNoData: "Tiada data",
        unknownArea: "Tidak dinyatakan",
        yAxisHours: "Masa Operasi (jam)",
        yAxisBinEmpties: "Jumlah Pengosongan (kali)"
      }
    };

    const LangState = window.AdminLang;
    let currentLang = (LangState && typeof LangState.getLang === "function")
      ? LangState.getLang()
      : (localStorage.getItem("sw_lang") || "th");
    syncLangMenuActive(currentLang);

    function t(key){ return translations[currentLang][key] || key; }

    function formatDurationLabel(minutes){
      const totalSeconds = Math.round(minutes * 60);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if(currentLang === "en") return (h>0?`${h}h `:"") + (m>0?`${m}m `:"") + `${s}s`;
      if(currentLang === "ms") return (h>0?`${h} jam `:"") + (m>0?`${m} minit `:"") + `${s} saat`;
      return (h>0?`${h} ‡∏ä‡∏°. `:"") + (m>0?`${m} ‡∏ô‡∏≤‡∏ó‡∏µ `:"") + `${s} ‡∏ß‡∏¥`;
    }

    function formatHoursMinutesFromHours(hours){
      if(typeof hours !== "number" || Number.isNaN(hours)) return "-";
      const totalMinutes = Math.round(hours * 60);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      if(currentLang === "en") return `${h}h ${m}m`;
      if(currentLang === "ms") return `${h} jam ${m} minit`;
      return `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }

    function getDateFilterConfig(){
      const key = currentTimeFilter;
      const now = new Date();
      if(key === "all") return { type:"all" };
      let start = new Date();
      if(key === "week") start.setDate(now.getDate() - 7);
      else if(key === "month") start.setDate(now.getDate() - 30);
      else if(key === "year") start.setDate(now.getDate() - 365);
      start.setHours(0,0,0,0);
      const end = new Date(now);
      end.setHours(23,59,59,999);
      return { type:"range", start, end };
    }

    function isDocDateInRange(docIdDateStr, filterConfig){
      if(filterConfig.type === "all") return true;
      const d = new Date(docIdDateStr);
      if(isNaN(d)) return false;
      return d >= filterConfig.start && d <= filterConfig.end;
    }

    function isInRange(date, filterConfig){
      if(filterConfig.type === "all") return true;
      if(!date) return false;
      return date >= filterConfig.start && date <= filterConfig.end;
    }

    function filterDataByDate(sourceData, filterConfig){
      if(!sourceData) return {};
      if(filterConfig.type === "all") return sourceData;
      const filtered = {};
      Object.entries(sourceData).forEach(([zoneId, zData])=>{
        const binLogs = Array.isArray(zData.binLogs)
          ? zData.binLogs.filter(log=>isInRange(log.date, filterConfig))
          : [];
        const truckRuns = Array.isArray(zData.truckRuns)
          ? zData.truckRuns.filter(run=>isInRange(run.date, filterConfig))
          : [];
        filtered[zoneId] = { zoneName: zData.zoneName, binLogs, truckRuns };
      });
      return filtered;
    }

    function getLogDate(data){
      const cand = data.createdAt || data.timestamp || data.emptiedAt || data.time;
      return (cand && typeof cand.toDate === "function") ? cand.toDate() : (cand ? new Date(cand) : null);
    }

    function setAdminUI(admin){
      const displayName = admin?.fullName || admin?.displayName || admin?.username || admin?.email || admin?.uid || "-";
      const roleLabel = admin?.roleLabel || "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö";

      const nameTop = document.getElementById("adminNameTop");
      const roleTop = document.getElementById("adminRoleTop");
      const nameSide = document.getElementById("adminNameSide");
      const roleSide = document.getElementById("adminRoleSide");

      if(nameTop) nameTop.textContent = displayName;
      if(roleTop) roleTop.textContent = roleLabel;
      if(nameSide) nameSide.textContent = displayName;
      if(roleSide) roleSide.textContent = roleLabel;
    }

    function watchAdminAuth(){
      let tries = 0;
      let resolving = false;
      const timer = setInterval(async ()=>{
        if(resolving) return;
        resolving = true;
        tries++;

        let admin = window.ADMIN_AUTH || window.currentUser || currentUser || null;
        if(!admin && currentUserPromise && typeof currentUserPromise.then === "function"){
          try{
            admin = await currentUserPromise;
            if(admin) window.currentUser = admin;
          }catch(err){
            console.error("Auth resolve error:", err);
          }
        }

        if(admin){
          setAdminUI(admin);
          clearInterval(timer);
        } else if(tries > 80){
          clearInterval(timer);
        }
        resolving = false;
      }, 250);
    }

    async function loadAllData(options = {}){
      const { useCache = true, forceAll = false } = options;
      const filterConfig = getDateFilterConfig();

      if(useCache && !forceAll && globalAllData && Object.keys(globalAllData).length > 0){
        return filterDataByDate(globalAllData, filterConfig);
      }

      if(cachedZones.length === 0){
        const zonesSnap = await db.collection("zones").orderBy("name").get();
        cachedZones = [];
        zonesSnap.forEach(d=>{
          const data = d.data() || {};
          cachedZones.push({
            zoneId: d.id,
            displayName: data.name || d.id,
            area: data.area || ""
          });
        });

        zoneFilterSelect.innerHTML = `<option value="all">${t("zoneAll")}</option>`;
        cachedZones.forEach(z=>{
          const opt = document.createElement("option");
          opt.value = z.zoneId;
          opt.textContent = z.area ? `${z.displayName} (${z.area})` : z.displayName;
          zoneFilterSelect.appendChild(opt);
        });
      } else {
        if(zoneFilterSelect.options.length > 0) zoneFilterSelect.options[0].textContent = t("zoneAll");
      }

      const localData = {};
      cachedZones.forEach(z=>{
        localData[z.zoneId] = { zoneName: z.displayName, binLogs: [], truckRuns: [] };
      });

      const applyFilter = !forceAll && filterConfig.type !== "all";

      for(const zone of cachedZones){
        try{
          const binsSnap = await db.collection("smartbins").doc(zone.zoneId).collection("bin_data").get();
          for(const bDoc of binsSnap.docs){
            const binId = bDoc.id;
            const binName = bDoc.data().binId || binId;
            const logsSnap = await bDoc.ref.collection("emptying_trash").get();
            logsSnap.forEach(lDoc=>{
              const d = lDoc.data();
              const date = getLogDate(d);
              if(!applyFilter || isInRange(date, filterConfig)){
                localData[zone.zoneId].binLogs.push({ date, detail: binName, rawData: d });
              }
            });
          }
        }catch(err){ console.error("Error bins:", err); }
      }

      try{
        const truckOpSnap = await db.collectionGroup("truck_operating_time").get();
        const scheduleRequests = new Set();
        const tempTruckRuns = [];

        truckOpSnap.forEach(doc=>{
          const pathSegments = doc.ref.path.split("/");
          if(pathSegments.length < 6) return;

          const zoneId = pathSegments[1];
          const truckId = pathSegments[3];
          const dateStr = doc.id;

          if(applyFilter && !isDocDateInRange(dateStr, filterConfig)) return;
          if(!localData[zoneId]) return;

          const data = doc.data() || {};
          let updatedDate = null;
          if(data.updatedAt && typeof data.updatedAt.toDate === "function") updatedDate = data.updatedAt.toDate();

          let startTime = null;
          let durationMinutes = 0;

          if(data.startAt && typeof data.startAt.toDate === "function"){
            startTime = data.startAt.toDate();
            let endTime = new Date();
            if(data.finishedAt && typeof data.finishedAt.toDate === "function") endTime = data.finishedAt.toDate();
            else if(data.endAt && typeof data.endAt.toDate === "function") endTime = data.endAt.toDate();
            durationMinutes = Math.max(0, (endTime - startTime) / 60000);
          } else if(data.segments){
            const keys = Object.keys(data.segments).sort((a,b)=>Number(a)-Number(b));
            if(keys.length>0){
              const firstSeg = data.segments[keys[0]];
              const lastSeg = data.segments[keys[keys.length-1]];
              if(firstSeg && firstSeg.startAt){
                startTime = firstSeg.startAt.toDate();
                const end = (lastSeg && lastSeg.endAt) ? lastSeg.endAt.toDate() : new Date();
                durationMinutes = Math.max(0, (end - startTime)/60000);
              }
            }
          }

          if(durationMinutes > 0 && startTime){
            scheduleRequests.add(`${zoneId}|${dateStr}`);
            const displayDate = updatedDate || startTime;

            tempTruckRuns.push({
              zoneId, dateStr,
              recordDate: displayDate,
              startAt: startTime,
              truckId,
              minutes: durationMinutes,
              val: formatDurationLabel(durationMinutes),
              rawData: data
            });
          }
        });

        const scheduleMap = {};
        const reqArray = Array.from(scheduleRequests);
        const schedulePromises = reqArray.map(async (key)=>{
          const [zId, dStr] = key.split("|");
          try{
            const docSnap = await db.collection("truck_schedule").doc(zId).collection("days").doc(dStr).get();
            if(docSnap.exists) scheduleMap[key] = docSnap.data();
          }catch(e){}
        });
        await Promise.all(schedulePromises);

        tempTruckRuns.forEach(run=>{
          const key = `${run.zoneId}|${run.dateStr}`;
          const scheduleData = scheduleMap[key];

          let areaList = [];
          if(scheduleData){
            if(scheduleData.truckId === run.truckId && Array.isArray(scheduleData.areas)){
              areaList = scheduleData.areas.map(a => a.areaName || a.areaId);
            } else if(Array.isArray(scheduleData.routes)){
              const foundRoute = scheduleData.routes.find(r => r.truckId === run.truckId);
              if(foundRoute && Array.isArray(foundRoute.areas)){
                areaList = foundRoute.areas.map(a => a.areaName || a.areaId);
              }
            } else if(scheduleData[run.truckId] && Array.isArray(scheduleData[run.truckId].areas)){
              areaList = scheduleData[run.truckId].areas.map(a => a.areaName || a.areaId);
            }
          }
          if(!Array.isArray(areaList)) areaList = [];

          localData[run.zoneId].truckRuns.push({
            date: run.recordDate,
            startAt: run.startAt,
            detail: run.truckId,
            minutes: run.minutes,
            val: run.val,
            rawData: run.rawData,
            areaNames: areaList,
            areaStr: areaList.length>0 ? areaList.join(", ") : t("unknownArea")
          });
        });

      }catch(err){ console.error("Error truck op:", err); }

      if(forceAll || filterConfig.type === "all") globalAllData = localData;

      if(forceAll && filterConfig.type !== "all"){
        return filterDataByDate(localData, filterConfig);
      }

      return localData;
    }

    function refreshCachedLangStrings(){
      const unknownAreaText = t("unknownArea");
      const dataSets = [globalLastData, globalAllData];
      dataSets.forEach(data=>{
        if(!data) return;
        Object.values(data).forEach(zData=>{
          if(!zData) return;
          if(Array.isArray(zData.truckRuns)){
            zData.truckRuns.forEach(run=>{
              if(run && typeof run.minutes === "number"){
                run.val = formatDurationLabel(run.minutes);
              }
              if(run && Array.isArray(run.areaNames) && run.areaNames.length === 0){
                run.areaStr = unknownAreaText;
              }
            });
          }
        });
      });
    }

    async function renderOverview(silent = false, useCache = false){
      const myRenderId = ++latestRenderId;
      if (!silent) showLoader();
      const fetchedData = await loadAllData({ useCache });
      if(myRenderId !== latestRenderId) return;

      globalLastData = fetchedData;
      summaryCardsGrid.innerHTML = "";

      let totalBinEmpties = 0, totalTruckRuns = 0;
      Object.values(globalLastData).forEach(zData=>{
        totalBinEmpties += zData.binLogs.length;
        totalTruckRuns += zData.truckRuns.length;
      });

      const createCard = (iconRi, title, stat, subStatHtml, type) => {
        const div = document.createElement("div");
        div.className = "summary-card";
        div.onclick = () => showDetail(type);
        div.innerHTML = `
          <div class="card-icon-box"><i class="${iconRi}"></i></div>
          <div class="card-body">
            <div class="card-label">${title}</div>
            <div class="big-stat">${stat}</div>
            <div class="sub-stat">${subStatHtml}</div>
          </div>`;
        return div;
      };

      summaryCardsGrid.appendChild(
        createCard("ri-delete-bin-6-line", t("cardBinTitle"), totalBinEmpties.toLocaleString(),
          `<i class="ri-bar-chart-fill"></i> ${t("unitTimes")}`, "bin")
      );

      summaryCardsGrid.appendChild(
        createCard("ri-truck-line", t("cardTruckTitle"), totalTruckRuns.toLocaleString(),
          `<i class="ri-bar-chart-fill"></i> ${t("unitTimes")}`, "truck")
      );

      if (!silent) hideLoader();
    }

    async function prefetchAllData(){
      if(prefetchingAll) return;
      if(globalAllData && Object.keys(globalAllData).length > 0) return;
      prefetchingAll = true;
      try{
        await loadAllData({ useCache: false, forceAll: true });
      }catch(err){
        console.warn("Prefetch all data failed:", err);
      }finally{
        prefetchingAll = false;
      }
    }

    function showDetail(type){
      currentView = "detail";
      currentDetailType = type;

      overviewSection.style.display = "none";
      detailSection.style.display = "block";
      btnBack.style.display = "inline-flex";

      timeFilterDetail.value = currentTimeFilter;
      searchInput.value = "";
      document.body.classList.add("show-detail");

      updateDetailView(type);
    }

    function updateDetailView(type){
      if(currentView !== "detail") return;

      const selectedZoneId = zoneFilterSelect.value;
      const isSingleZone = selectedZoneId !== "all";

      const chartLabels = [];
      const chartData = [];
      let allRows = [];
      let chartLabelText = "";

      const tableHead = document.querySelector("#historyTableBody").previousElementSibling;
      if(tableHead){
        if(type === "bin"){
          tableHead.innerHTML = `<tr><th>${t("thDate")}</th><th>${t("thZone")}</th><th>${t("thBinId")}</th><th>${t("thTruckId")}</th><th>${t("thFillPercent")}</th><th>${t("thWeightGram")}</th></tr>`;
        } else {
          tableHead.innerHTML = `<tr><th>${t("thDate")}</th><th>${t("thZone")}</th><th>${t("thTruckId")}</th><th>${t("thArea")}</th><th>${t("unitMinutes")}</th></tr>`;
        }
      }

      const graphMap = new Map();

      if(type === "bin"){
        chartLabelText = t("cardBinTitle");
        sectionTitle.textContent = isSingleZone
          ? `${t("detailBinTitle")} - ${cachedZones.find(z=>z.zoneId===selectedZoneId)?.displayName || ""}`
          : t("detailBinTitle");

        cachedZones.forEach(zone=>{
          if(isSingleZone && zone.zoneId !== selectedZoneId) return;
          const zData = globalLastData[zone.zoneId];
          if(!zData) return;

          zData.binLogs.forEach(log=>{
            const raw = log.rawData || {};
            const truckId = raw.truckId || "-";
            allRows.push({
              date: log.date,
              zoneName: zone.displayName,
              col_bin: log.detail,
              col_truck: truckId,
              col_fill: raw.levelBefore ?? 0,
              col_weight: Number(raw.weightBefore ?? 0).toFixed(2),
              type: "bin"
            });

            let key = isSingleZone ? (log.detail || "Unknown") : zone.displayName;
            let label = key;
            if(!graphMap.has(key)) graphMap.set(key, { label, val: 0 });
            graphMap.get(key).val += 1;
          });
        });
      } else {
        chartLabelText = t("yAxisHours");
        sectionTitle.textContent = isSingleZone
          ? `${t("detailTruckTitle")} - ${cachedZones.find(z=>z.zoneId===selectedZoneId)?.displayName || ""}`
          : t("detailTruckTitle");

        cachedZones.forEach(zone=>{
          if(isSingleZone && zone.zoneId !== selectedZoneId) return;
          const zData = globalLastData[zone.zoneId];
          if(!zData) return;

          zData.truckRuns.forEach(run=>{
            allRows.push({ ...run, zoneName: zone.displayName, type: "truck" });

            let key, label, sortVal;
            if(isSingleZone){
              const d = new Date(run.date);
              d.setHours(0,0,0,0);
              sortVal = d.getTime();
              key = sortVal;
              label = run.date.toLocaleDateString(currentLang === "th" ? "th-TH" : "en-GB", { day:"numeric", month:"short" });
            } else {
              key = zone.displayName;
              label = key;
              sortVal = key;
            }

            if(!graphMap.has(key)) graphMap.set(key, { label, val: 0, sortVal });
            graphMap.get(key).val += (run.minutes / 60);
          });
        });

        if(isSingleZone){
          const sorted = Array.from(graphMap.values()).sort((a,b)=>a.sortVal - b.sortVal);
          graphMap.clear();
          sorted.forEach(x=>graphMap.set(x.sortVal, x));
        }
      }

      Array.from(graphMap.values()).forEach(item=>{
        chartLabels.push(item.label);
        chartData.push(item.val);
      });

      if(detailChartInstance) detailChartInstance.destroy();

      const bg = (type === "bin") ? "rgba(14, 165, 233, 0.28)" : "rgba(16, 185, 129, 0.28)";
      const border = (type === "bin") ? "#0ea5e9" : "#10b981";
      const yAxisTitleText = (type === "bin") ? t("yAxisBinEmpties") : t("yAxisHours");

      detailChartInstance = new Chart(ctxDetail, {
        type: "bar",
        data: { labels: chartLabels, datasets: [{ label: chartLabelText, data: chartData, backgroundColor: bg, borderColor: border, borderWidth: 1, borderRadius: 6 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  if(type === "truck"){
                    const hoursVal = (context && context.parsed) ? context.parsed.y : 0;
                    return formatHoursMinutesFromHours(hoursVal);
                  }
                  const value = (context && context.formattedValue) ? context.formattedValue : (context.parsed ? context.parsed.y : "");
                  return `${value}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              title: {
                display: Boolean(yAxisTitleText),
                text: yAxisTitleText
              }
            },
            x: { grid: { display: false } }
          }
        }
      });

      currentTableRows = allRows;
      renderTableOnly();
    }

    function renderTableOnly(){
      const searchTerm = (searchInput.value || "").toLowerCase().trim();
      const tableBody = document.getElementById("historyTableBody");
      tableBody.innerHTML = "";

      const filteredRows = currentTableRows.filter(item=>{
        if(!searchTerm) return true;

        const dateStrSearch = item.date
          ? item.date.toLocaleString(currentLang === "th" ? "th-TH" : "en-US").toLowerCase()
          : "";

        if(item.type === "bin"){
          return (dateStrSearch && dateStrSearch.includes(searchTerm)) ||
                 (item.col_bin && item.col_bin.toLowerCase().includes(searchTerm)) ||
                 (item.col_truck && item.col_truck.toLowerCase().includes(searchTerm));
        } else {
          return (dateStrSearch && dateStrSearch.includes(searchTerm)) ||
                 (item.detail && item.detail.toLowerCase().includes(searchTerm)) ||
                 (item.areaStr && item.areaStr.toLowerCase().includes(searchTerm));
        }
      });

      filteredRows.sort((a,b)=> b.date - a.date);

      if(filteredRows.length === 0){
        const colSpan = (currentDetailType === "bin") ? 6 : 5;
        tableBody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; color:#94a3b8; padding:30px;">${t("tableNoData")}</td></tr>`;
        return;
      }

      filteredRows.forEach(item=>{
        const tr = document.createElement("tr");
        const dateStr = item.date ? item.date.toLocaleString(currentLang === "th" ? "th-TH" : "en-US") : "-";

        if(item.type === "bin"){
          const fillNum = Number(item.col_fill ?? 0);
          const fillStyle = (fillNum < 80)
            ? "color:#059669; font-weight:800;"
            : "color:#dc2626; font-weight:800;";

          tr.innerHTML = `<td>${dateStr}</td>
                          <td><span class="badge-zone">${item.zoneName}</span></td>
                          <td style="font-weight:700;">${item.col_bin}</td>
                          <td style="font-weight:400; color:#111827;">${item.col_truck}</td>
                          <td style="${fillStyle}">${fillNum}%</td>
                          <td style="font-weight:900; text-align:center;">${item.col_weight}</td>`;
        } else {
          const areaHtml = (item.areaNames && item.areaNames.length > 0)
            ? item.areaNames.map(a=>`<span class="badge-area">${a}</span>`).join("")
            : `<span style="color:#94a3b8; font-size:12px;">${item.areaStr}</span>`;

          tr.innerHTML = `<td>${dateStr}</td>
                          <td><span class="badge-zone">${item.zoneName}</span></td>
                          <td style="font-weight:400; color:#111827;">${item.detail}</td>
                          <td>${areaHtml}</td>
                          <td style="font-weight:900; color:#0ea5e9;">${item.val}</td>`;
        }
        tableBody.appendChild(tr);
      });
    }

    function goBackToOverview(){
      currentView = "overview";
      currentDetailType = null;
      detailSection.style.display = "none";
      btnBack.style.display = "none";
      overviewSection.style.display = "block";
      zoneFilterSelect.value = "all";
      searchInput.value = "";
      sectionTitle.textContent = "";
      document.body.classList.remove("show-detail");
      renderOverview(true, true);
    }

    function changeLanguage(lang, options = {}){
      if(!translations[lang]) return;
      const { refreshData = true } = options;
      currentLang = lang;
      localStorage.setItem("sw_lang", lang);
      syncLangMenuActive(lang);

      document.title = t("pageTitle");
      document.getElementById("pageTitleHeading").textContent = t("pageTitle");
      document.getElementById("pageSubtitle").textContent = t("subtitle");
      if(loaderTextEl) loaderTextEl.textContent = t("loaderText");
      document.getElementById("backText").textContent = t("backBtn");
      document.getElementById("tableTitle").textContent = t("tableTitle");
      searchInput.placeholder = t("searchPlaceholder");

      if(zoneFilterSelect.options.length > 0) zoneFilterSelect.options[0].textContent = t("zoneAll");

      const timeLabels = {
        all: t("timeAll"),
        week: t("timeWeek"),
        month: t("timeMonth"),
        year: t("timeYear")
      };
      [timeFilterSelect, timeFilterDetail].forEach(select => {
        if (!select) return;
        Array.from(select.options).forEach(opt => {
          if (timeLabels[opt.value]) opt.textContent = timeLabels[opt.value];
        });
      });

      refreshCachedLangStrings();
      if(refreshData){
        if(currentView === "overview") renderOverview(true, true);
        else if(currentView === "detail" && currentDetailType) updateDetailView(currentDetailType);
      }
    }

    timeFilterSelect.addEventListener("change", async (e)=>{
      currentTimeFilter = e.target.value;
      localStorage.setItem("sw_report_time_filter", currentTimeFilter);
      timeFilterDetail.value = currentTimeFilter;

      if(currentView === "overview") await renderOverview(true, true);
      else {
        const fetched = await loadAllData({ useCache: true });
        globalLastData = fetched;
        updateDetailView(currentDetailType);
      }
    });

    timeFilterDetail.addEventListener("change", async (e)=>{
      currentTimeFilter = e.target.value;
      localStorage.setItem("sw_report_time_filter", currentTimeFilter);
      timeFilterSelect.value = currentTimeFilter;

      const fetched = await loadAllData({ useCache: true });
      globalLastData = fetched;
      updateDetailView(currentDetailType);
    });

    zoneFilterSelect.addEventListener("change", ()=>{ if(currentDetailType) updateDetailView(currentDetailType); });
    searchInput.addEventListener("keyup", ()=>{ if(currentDetailType) renderTableOnly(); });

    (async ()=>{
      watchAdminAuth();
      changeLanguage(currentLang, { refreshData: false });
      await renderOverview();
      prefetchAllData();
    })();

    if (LangState && typeof LangState.onChange === "function") {
      LangState.onChange(lang => {
        if (lang && lang !== currentLang) {
          changeLanguage(lang);
        }
      });
    }
    window.addEventListener("storage", e => {
      if (e.key !== "sw_lang") return;
      const lang = e.newValue || "th";
      if (lang && lang !== currentLang) changeLanguage(lang);
    });
  </script>
</body>
</html>
