<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <title>Smart Waste - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>

  <script>
    (function initMapT() {
      const lang = localStorage.getItem("sw_lang") || "th";
      if (!window.SW_Translations || !window.SW_Translations[lang]) {
        window.T = {};
        return;
      }
      window.T = window.SW_Translations[lang];
    })();
  </script>

  <link rel="stylesheet" href="../Admin/admin-shell.css">
  <link rel="stylesheet" href="user-shell.css">
  <link rel="stylesheet" href="user-map.css">

  <script src="../Login/auth.js"></script>

  
</head>

<body data-active-nav="map">
  <script src="user-shell.js" defer></script>

  <div id="globalLoader" class="shell-loader show">
    <div class="loader-box">
      <div class="loader-spinner"></div>
      <div class="loader-text" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>
    </div>
  </div>

  <header class="top-header">
    <div class="brand-left">
      <button class="menu-toggle" id="menuToggleBtn" type="button" aria-label="‡πÄ‡∏°‡∏ô‡∏π">
        <i class="ri-menu-fill"></i>
      </button>
      <div class="brand-mark"><i class="ri-recycle-line"></i></div>
      <div class="brand-name" id="brandTitle">Smart Waste</div>
    </div>
    <div class="header-right">
      <div class="lang-switcher" style="position:relative;">
        <button class="icon-btn" id="langIconBtn" type="button" aria-label="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤">
          <i class="ri-global-line"></i>
        </button>
        <div class="lang-menu" id="langMenu">
          <button type="button" data-lang="th">‡πÑ‡∏ó‡∏¢</button>
          <button type="button" data-lang="en">English</button>
          <button type="button" data-lang="ms">Bahasa Melayu</button>
        </div>
      </div>
      <div class="header-user" id="userProfileTop">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-meta">
          <div class="user-name" id="userLabel">Loading...</div>
          <div class="user-role" id="userRole"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="drawer-overlay" id="drawerOverlay"></div>

  <aside class="sidebar" id="sidebar" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á">
    <div class="sidebar-user">
      <div class="user-avatar" id="userAvatarMobile">?</div>
      <div class="user-meta">
        <div class="user-name" id="userLabelSide"></div>
        <div class="user-role" id="userRoleSide"></div>
      </div>
    </div>
    <nav class="menu">
      <a href="home.html" data-nav="home"><i class="ri-delete-bin-2-line"></i> <span class="menu-text" id="menuMyBins">‡∏ñ‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></a>
      <a href="map.html" data-nav="map"><i class="ri-map-pin-2-line"></i> <span class="menu-text" id="menuMap">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span></a>
    </nav>
    <div class="sw-logout-slot">
      <button onclick="SWAuth.logout()" class="sw-logout-btn" type="button"><i class="ri-logout-box-line"></i> <span id="menuLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></button>
    </div>
  </aside>

  <main class="admin-main user-main">
    <div class="page-head">
      <div>
        <h1 class="page-title" id="mapTitle">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
        <p class="page-sub" id="mapSubtitle">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
      </div>
    </div>

    <div class="map-layout">
      <div class="card map-card">
        <div id="map" aria-label="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"></div>
      </div>
      <div class="card map-panel">
        <div>
          <div class="section-header"><h2><i class="ri-delete-bin-line"></i> <span id="binSectionTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</span></h2><span class="badge" id="binCount">0</span></div>
          <div id="binList" class="list-container" style="max-height: 250px;"></div>
        </div>
        <hr style="border:0; border-top:1px solid #f1f5f9; margin: 5px 0;">
        <div>
          <div class="section-header"><h2><i class="ri-truck-line"></i> <span id="truckSectionTitle">‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞ (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)</span></h2><span class="badge" id="truckCount" style="background:#fee2e2; color:#ef4444;">0</span></div>
          <div id="truckList" class="list-container" style="max-height: 200px;"></div>
          <p id="truckStatus" style="font-size:12px; text-align:center; margin-top:10px; color:#64748b;"></p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Setup ---
    const $ = id => document.getElementById(id);
    const userLabelEl = $("userLabel");
    const userAvatarEl = $("userAvatar");
    const userAvatarMobile = $("userAvatarMobile");
    const userLabelSide = $("userLabelSide");
    const userRoleEl = $("userRole");
    const userRoleSide = $("userRoleSide");
    const loader = $("globalLoader");
    const t = (key, fallback) => (window.T && window.T[key]) || fallback;
    let binsLoaded = false;
    let trucksLoaded = false;
    function tryHideLoader() {
        if (!loader) return;
        if (binsLoaded && trucksLoaded) loader.classList.remove("show");
    }

    const firebaseConfig = {
      apiKey: "AIzaSyA9SQW3iUwZWCgeG6eOYvvMU5g2hb_Zlrw",
      authDomain: "smartwaste2568-1d792.firebaseapp.com",
      databaseURL: "https://smartwaste2568-1d792-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartwaste2568-1d792",
      storageBucket: "smartwaste2568-1d792.firebasestorage.app",
      messagingSenderId: "1041339993312",
      appId: "1:1041339993312:web:65b26ea83dcbf4f8b29485",
      measurementId: "G-FV5TEPVZWN"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const database = firebase.database();

    const map = L.map("map").setView([13.7563, 100.5018], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap" }).addTo(map);
    setTimeout(() => map.invalidateSize(), 200);

    // --- Variables ---
    const binMarkers = new Map();
    const truckMarkers = new Map();
    const truckIconState = new Map();
    const binDocCache = new Map();
    let rtdbListeners = new Map(); 
    let deviceLastSeen = new Map(); 
    let prevTruckTimestamps = new Map(); 
    
    let selectedTruckId = null; 
    let selectedBinId = null; 
    let truckRTDBRef = null;
    let userZones = new Set();
    const BIN_FOCUS_ZOOM = 16;
    let zoomed = false;

    // üî• ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ üî•
    const OFFLINE_TIMEOUT = 10000; 
    const MAX_DATA_AGE = 60000; 

    // --- MAIN ---
    async function initApp() {
        try {
            const currentUser = await window.SWAuth.requireAuth([2]); 
            if (!currentUser || !currentUser.username) throw new Error("User data incomplete");

            const displayName = currentUser.fullName || currentUser.username || "User";
            const initial = displayName.charAt(0).toUpperCase();
            userLabelEl.textContent = displayName;
            if (userLabelSide) userLabelSide.textContent = displayName;
            userAvatarEl.textContent = initial;
            if (userAvatarMobile) userAvatarMobile.textContent = initial;
            const roleText = (window.T && window.T.userRole_user) || "User";
            if (userRoleEl) userRoleEl.textContent = roleText;
            if (userRoleSide) userRoleSide.textContent = roleText;

            startFetchingData(currentUser);

            setInterval(() => {
                const now = Date.now();
                deviceLastSeen.forEach((info, id) => {
                    const isOnline = (now - info.lastSeenClientTime) < OFFLINE_TIMEOUT;
                    updateVisuals(id, isOnline, info);
                });
            }, 1000);

        } catch (error) {
            console.error("Auth Error:", error);
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' });
        }
    }
    initApp();

    // --- VISUALS ---
    function clearAllSelections() {
        document.querySelectorAll('.list-card').forEach(el => el.classList.remove('active'));
    }

    function getFillColor(val) {
      if (val === null || val === undefined) return "#94a3b8"; 
      if (val >= 80) return "#ef4444"; 
      if (val >= 50) return "#f59e0b"; 
      return "#10b981"; 
    }

    function formatWeight(weight) {
      if (typeof weight !== "number" || Number.isNaN(weight)) return "N/A";
      const rounded = Math.round(weight * 100) / 100;
      const localeMap = { th: "th-TH", en: "en-US", ms: "ms-MY" };
      const lang = (typeof currentLang === "string" && currentLang) || localStorage.getItem("sw_lang") || "th";
      const locale = localeMap[lang] || "th-TH";
      const fractionDigits = rounded % 1 ? 2 : 0;
      return `${rounded.toLocaleString(locale, {
        minimumFractionDigits: fractionDigits,
        maximumFractionDigits: 2
      })} g`;
    }

    function buildBinIcon(fillLevel) {
      const color = getFillColor(fillLevel);
      const label = (fillLevel !== null && fillLevel !== undefined) ? `${fillLevel}%` : "?";
      return L.divIcon({
        className: "bin-icon",
        html: `<div class="bin-pin" style="--pin-color:${color};"><div class="bin-pin__bubble"><i class="ri-delete-bin-fill"></i></div><div class="bin-pin__label">${label}</div></div>`,
        iconSize: [40, 60], iconAnchor: [20, 50], popupAnchor: [0, -45]
      });
    }

    function buildTruckIcon(isOnline) {
      if (!isOnline) {
          return L.divIcon({
            className: "truck-icon",
            html: `<div class="truck-pin" style="--pin-color:#94a3b8;"><div class="truck-pin__bubble">üöõ</div></div>`,
            iconSize: [50, 50], iconAnchor: [25, 25], popupAnchor: [0, -30]
          });
      }
      return L.divIcon({
        className: "truck-icon",
        html: `<div class="truck-pin"><div class="truck-pulse"></div><div class="truck-pin__bubble">üöõ</div></div>`,
        iconSize: [50, 50], iconAnchor: [25, 25], popupAnchor: [0, -30]
      });
    }

    // --- CENTRAL UPDATER ---
    function updateVisuals(id, isOnline, info) {
        const statusColor = isOnline ? "#22c55e" : "#94a3b8"; 

        if (info.type === 'bin') {
            const badgeEl = document.getElementById(`fill-text-${id}`);
            const dotEl = document.getElementById(`fill-dot-${id}`);
            
            if (badgeEl) {
                badgeEl.innerText = (info.fillLevel !== null) ? `${info.fillLevel}%` : "N/A";
                badgeEl.style.color = isOnline ? "var(--text-main)" : "#94a3b8";
            }
            if (dotEl) {
                dotEl.style.background = statusColor;
                dotEl.style.boxShadow = isOnline ? "0 0 0 2px rgba(34, 197, 94, 0.2)" : "none";
                dotEl.title = isOnline ? "Online" : "Offline";
            }

            if (binMarkers.has(id)) {
                const marker = binMarkers.get(id);
                // ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏°‡∏≠ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏≤)
                const newIcon = buildBinIcon(info.fillLevel);
                marker.setIcon(newIcon);

            if (marker.isPopupOpen()) {
                     const weightText = (info.weight !== null && info.weight !== undefined) ? formatWeight(info.weight) : "N/A";
                     const popupContent = `
                        <div class="custom-popup-header" style="background:${isOnline ? 'var(--primary)' : '#64748b'}">
                            <i class="ri-map-pin-line"></i> ${info.binId} 
                            <span style="font-size:10px; float:right; margin-top:2px;">${isOnline ? t("mapPopupOnline", "Online") : t("mapPopupOffline", "Offline")}</span>
                        </div>
                        <div class="custom-popup-body">
                            <b>${t("mapPopupZoneLabel", "Zone")}:</b> ${info.zone}<br>
                            <b>${t("mapPopupFillLabel", "Fill level")}:</b> ${info.fillLevel !== null ? info.fillLevel + "%" : "N/A"}<br>
                            <b>${t("labelWeight", "Weight")}:</b> ${weightText}<br>
                            <span style="color:#64748b; font-size:11px">${t("mapPopupMacLabel", "MAC")}: ${info.macAddress}</span>
                        </div>`;
                     if (marker.getPopup().getContent() !== popupContent) marker.setPopupContent(popupContent);
                }
            }
        }

        if (info.type === 'truck') {
            const dotEl = document.getElementById(`truck-dot-${id}`);
            if (dotEl) {
                dotEl.style.background = statusColor;
                dotEl.style.boxShadow = isOnline ? "0 0 0 2px rgba(34, 197, 94, 0.2)" : "none";
            }
            if (truckMarkers.has(id)) {
                const marker = truckMarkers.get(id);
                const prevState = truckIconState.get(id);
                if (prevState !== isOnline) {
                    const newIcon = buildTruckIcon(isOnline);
                    marker.setIcon(newIcon);
                    truckIconState.set(id, isOnline);
                }
            }
        }
    }

    async function fetchLinkedBinDoc(path) {
      if (!path) return null;
      if (!binDocCache.has(path)) {
        try {
          const snap = await firestore.doc(path).get();
          if (snap.exists) binDocCache.set(path, { id: snap.id, ...snap.data() });
          else binDocCache.set(path, null);
        } catch (e) { return null; }
      }
      return binDocCache.get(path);
    }

    function focusBin(lat, lng, binId) {
      if (selectedBinId === binId) {
        selectedBinId = null;
        map.closePopup();
        clearAllSelections();
        return;
      }
      if (lat && lng) {
        selectedTruckId = null; selectedBinId = binId; 
        map.invalidateSize();
        map.setView([lat, lng], BIN_FOCUS_ZOOM, { animate: true });
        if (binMarkers.has(binId)) binMarkers.get(binId).openPopup();
        clearAllSelections();
        const card = document.getElementById(`bin-card-${binId}`);
        if(card) card.classList.add('active');
      }
    }

    function selectTruck(driverId, lat, lng) {
        if (selectedTruckId === driverId) {
            selectedTruckId = null;
            map.closePopup();
            clearAllSelections();
            return;
        }
        selectedTruckId = driverId; selectedBinId = null;
        if (lat && lng) {
            map.invalidateSize();
            map.setView([lat, lng], 16, { animate: true });
        }
        if (truckMarkers.has(driverId)) truckMarkers.get(driverId).openPopup();
        clearAllSelections();
        const card = document.getElementById(`truck-card-${driverId}`);
        if (card) card.classList.add('active');
    }

    // --- DATA ---
    function startFetchingData(currentUser) {
        const targetOwner = currentUser.username;
        firestore.collectionGroup("bin_data").where("ownerUsername", "==", targetOwner)
        .onSnapshot(async snapshot => {
            rtdbListeners.forEach((val) => val.ref.off('value', val.listener));
            rtdbListeners.clear();
            binsLoaded = true;
            
            if (snapshot.empty) {
                $("binList").innerHTML = `<p style="text-align:center; color:#999; margin-top:20px; font-size:12px;">${t("mapNoBins", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")}</p>`;
                $("binCount").innerText = "0";
                trucksLoaded = true;
                tryHideLoader();
                return;
            }

            $("binList").innerHTML = "";
            let count = 0;
            const bounds = [];
            userZones.clear(); 

            const docs = await Promise.all(snapshot.docs.map(async doc => {
                const d = doc.data();
                let lat = parseFloat(d.lat), lng = parseFloat(d.lng);
                let zone = d.zone, binId = d.binId || doc.id, macAddress = d.macAddress; 

                if ((isNaN(lat) || isNaN(lng)) && d.binDocPath) {
                    const linked = await fetchLinkedBinDoc(d.binDocPath);
                    if (linked) {
                        lat = parseFloat(linked.lat); lng = parseFloat(linked.lng);
                        zone = zone || linked.zone; binId = binId !== doc.id ? binId : (linked.binId || binId);
                        macAddress = macAddress || linked.macAddress; 
                    }
                }
                return { id: doc.ref.path, lat, lng, zone: zone || t("mapZoneUnknown", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï"), binId, details: d.details, macAddress };
            }));

            docs.forEach(data => {
                if (isNaN(data.lat) || isNaN(data.lng)) return;
                if (data.zone) userZones.add(data.zone);

                deviceLastSeen.set(data.id, { 
                    type: 'bin', 
                    lastSeenClientTime: 0, 
                    fillLevel: null,
                    weight: null,
                    binId: data.binId,
                    zone: data.zone,
                    macAddress: data.macAddress
                });

                const item = document.createElement("div");
                item.className = "list-card";
                item.id = `bin-card-${data.id}`;
                item.onclick = () => focusBin(data.lat, data.lng, data.id);
                item.innerHTML = `
                <div class="card-icon"><i class="ri-delete-bin-6-line"></i></div>
                <div class="card-info">
                    <h4>${data.binId} <span style="font-size:10px; color:#888;">(${data.zone})</span></h4>
                    <p style="font-size:11px; color:#64748b;">MAC: ${data.macAddress || "-"}</p>
                </div>
                <div class="status-container">
                    <span id="fill-text-${data.id}" class="fill-percent">N/A</span>
                    <div id="fill-dot-${data.id}" class="status-dot" style="background:#94a3b8;"></div>
                </div>`;
                $("binList").appendChild(item);
                count++;
                bounds.push([data.lat, data.lng]);
                
                const popupContent = `<div class="custom-popup-header"><i class="ri-map-pin-line"></i> ${data.binId}</div><div class="custom-popup-body">${t("loadingData", "Loading...")}</div>`;

                if (binMarkers.has(data.id)) {
                    binMarkers.get(data.id).setLatLng([data.lat, data.lng]);
                } else {
                    const m = L.marker([data.lat, data.lng], { icon: buildBinIcon(null) }).addTo(map).bindPopup(popupContent, { autoPan: false });
                    m.on("click", () => focusBin(data.lat, data.lng, data.id));
                    binMarkers.set(data.id, m);
                }

                if (data.macAddress) subscribeToSensor(data.id, data.macAddress, data);
            });

            $("binCount").innerText = count;
            if (bounds.length > 0 && !zoomed) {
                map.fitBounds(bounds, { padding: [50, 50] });
                zoomed = true;
            }
            restartTruckListener();
            tryHideLoader();
        });
    }

    function subscribeToSensor(binId, macAddress, binData) {
        if (!macAddress) return;
        const sensorRef = database.ref(`esp32_devices/${macAddress}`);
        const listener = sensorRef.on('value', (snapshot) => {
            const data = snapshot.val();
            const liveLevel = data ? data.fillLevel : null;
            const liveWeight = data
              ? (typeof data.weight === "number" ? data.weight : (typeof data.weightGram === "number" ? data.weightGram : null))
              : null;
            
            let clientTime = 0; 
            if (data && data.lastUpdate) {
                const dataAge = Date.now() - data.lastUpdate;
                if (dataAge < MAX_DATA_AGE) {
                    clientTime = Date.now(); 
                }
            }

            const info = { 
                type: 'bin', 
                lastSeenClientTime: clientTime, 
                fillLevel: liveLevel,
                weight: liveWeight,
                binId: binData.binId,
                zone: binData.zone,
                macAddress: macAddress
            };
            deviceLastSeen.set(binId, info);

            const isOnline = (Date.now() - clientTime) < OFFLINE_TIMEOUT;
            updateVisuals(binId, isOnline, info);
        });
        rtdbListeners.set(binId, { ref: sensorRef, listener: listener });
    }

    function restartTruckListener() {
        if (truckRTDBRef) truckRTDBRef.off();
        if (userZones.size === 0) {
            $("truckList").innerHTML = `<p class="muted" style="text-align:center; font-size:12px; margin-top:10px;">${t("mapNoTrucksZone", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏ñ‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")}</p>`;
            trucksLoaded = true;
            tryHideLoader();
            return;
        }

        truckRTDBRef = database.ref('driver_live');
        truckRTDBRef.on('value', (snapshot) => {
            const drivers = snapshot.val();
            const list = $("truckList");
            list.innerHTML = ""; 
            let count = 0;
            const activeDriverIds = new Set();

            if (!drivers) {
                $("truckCount").innerText = "0";
                $("truckStatus").innerText = t("mapNoTrucksOnline", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");
                trucksLoaded = true;
                tryHideLoader();
                return;
            }

            Object.keys(drivers).forEach(driverId => {
                const d = drivers[driverId];
                if (!userZones.has(d.zoneId)) return;
                if (d.isWorking !== true) return;

                activeDriverIds.add(driverId);
                
                const prevTs = prevTruckTimestamps.get(driverId);
                let clientTime = 0;
                
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß timestamp ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
                if (d.lastUpdate !== prevTs) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï timestamp ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    prevTruckTimestamps.set(driverId, d.lastUpdate);
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô DB ‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡πÜ)
                    if ((Date.now() - d.lastUpdate) < MAX_DATA_AGE) {
                        clientTime = Date.now();
                    }
                } else {
                    // ‡∏ñ‡πâ‡∏≤ timestamp ‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏° = ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏±‡∏ö = ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á
                    // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ lastSeenClientTime ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ 0
                    const oldInfo = deviceLastSeen.get(driverId);
                    if (oldInfo) clientTime = oldInfo.lastSeenClientTime;
                }

                const info = { type: 'truck', lastSeenClientTime: clientTime };
                deviceLastSeen.set(driverId, info);
                
                const isOnline = (Date.now() - clientTime) < OFFLINE_TIMEOUT;
                updateVisuals(driverId, isOnline, info);

                if (d.lat && d.lng) {
                    if (truckMarkers.has(driverId)) {
                        const marker = truckMarkers.get(driverId);
                        marker.setLatLng([d.lat, d.lng]);
                        marker.setPopupContent(`
                            <div class="custom-popup-body">
                                <b>${t("mapPopupTruckLabel", "Truck")}:</b> ${d.truckId}<br><b>${t("mapPopupDriverLabel", "Driver")}:</b> ${d.driverName}<br>
                                <span style="font-size:10px; color:#64748b;">${t("mapPopupZoneLabel", "Zone")}: ${d.zoneId}</span>
                            </div>`);
                    } else {
                        const m = L.marker([d.lat, d.lng], { icon: buildTruckIcon(isOnline) }).addTo(map)
                    .bindPopup(`<div class="custom-popup-body"><b>${t("mapPopupTruckLabel", "Truck")}:</b> ${d.truckId}<br><b>${t("mapPopupDriverLabel", "Driver")}:</b> ${d.driverName}<br><span style="font-size:10px; color:#64748b;">${t("mapPopupZoneLabel", "Zone")}: ${d.zoneId}</span></div>`, { autoPan: false });
                        m.on("click", () => selectTruck(driverId, d.lat, d.lng));
                        truckMarkers.set(driverId, m);
                        truckIconState.set(driverId, isOnline);
                    }
                    if (selectedTruckId === driverId) map.panTo([d.lat, d.lng], { animate: true, duration: 1.0 });
                }

                const item = document.createElement("div");
                item.className = `list-card truck-card ${selectedTruckId === driverId ? 'active' : ''}`;
                item.id = `truck-card-${driverId}`;
                item.onclick = () => selectTruck(driverId, d.lat, d.lng);
                
                item.innerHTML = `
                   <div class="card-icon" style="color:#f43f5e; background:#fff1f2;"><i class="ri-truck-fill"></i></div>
                   <div class="card-info"><h4>${d.driverName} (${d.truckId})</h4><p>${t("mapTruckWorkingPrefix", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Ä¢")} ${d.zoneId}</p></div>
                   <div id="truck-dot-${driverId}" class="status-dot" style="position:static; background:${isOnline?'#22c55e':'#94a3b8'}; box-shadow: ${isOnline?'0 0 0 2px rgba(34, 197, 94, 0.2)':'none'};"></div>`;
                list.appendChild(item);
                count++;
            });

            for (const [id, marker] of truckMarkers) {
                if (!activeDriverIds.has(id)) {
                    map.removeLayer(marker);
                    truckMarkers.delete(id);
                    truckIconState.delete(id);
                }
            }
            $("truckCount").innerText = count;
            $("truckStatus").innerText = count === 0 ? t("mapNoTrucksOnline", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏ñ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ") : "";
            trucksLoaded = true;
            tryHideLoader();
        });
    }
  </script>

  <script>
    function applyMapTranslations() {
      if (!window.T) return;
      const titleFallback = window.T.menuMap ? `Smart Waste - ${window.T.menuMap}` : document.title;
      document.title = window.T.pageTitle_userMap || titleFallback;

      const brand = document.getElementById("brandTitle");
      if (brand) brand.textContent = window.T.brandTitle || "Smart Waste";

      const loadingText = document.getElementById("loadingText");
      if (loadingText) loadingText.textContent = window.T.loadingData || "Loading...";

      const menuMyBins = document.getElementById("menuMyBins");
      if (menuMyBins) menuMyBins.textContent = window.T.menuMyBins || "My Bins";
      const menuMap = document.getElementById("menuMap");
      if (menuMap) menuMap.textContent = window.T.menuMap || "Map";
      const menuLogout = document.getElementById("menuLogout");
      if (menuLogout) menuLogout.textContent = window.T.menuLogout || "Logout";

      const mapTitle = document.getElementById("mapTitle");
      if (mapTitle) mapTitle.textContent = window.T.mapTitle || window.T.menuMap || "Map";

      const mapSubtitle = document.getElementById("mapSubtitle");
      if (mapSubtitle) mapSubtitle.textContent = window.T.mapSubtitle || "";

      const binSectionTitle = document.getElementById("binSectionTitle");
      if (binSectionTitle) binSectionTitle.textContent = window.T.mapSectionBins || "Bins";

      const truckSectionTitle = document.getElementById("truckSectionTitle");
      if (truckSectionTitle) truckSectionTitle.textContent = window.T.mapSectionTrucks || "Trucks";

      const roleText = window.T.userRole_user || "User";
      const roleTop = document.getElementById("userRole");
      const roleSide = document.getElementById("userRoleSide");
      if (roleTop) roleTop.textContent = roleText;
      if (roleSide) roleSide.textContent = roleText;
    }

    function updateLangMenuActive() {
      const langMenu = document.getElementById("langMenu");
      if (!langMenu) return;
      langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === currentLang);
      });
    }

    let currentLang = localStorage.getItem("sw_lang") || "th";
    applyMapTranslations();
    updateLangMenuActive();

    function changeUserLanguage(lang) {
      if (!window.SW_Translations || !window.SW_Translations[lang]) return;
      currentLang = lang;
      localStorage.setItem("sw_lang", lang);
      window.T = window.SW_Translations[lang];
      applyMapTranslations();
      updateLangMenuActive();
    }

    const langMenu = document.getElementById("langMenu");
    if (langMenu) {
      langMenu.addEventListener("click", e => {
        const btn = e.target.closest("button[data-lang]");
        if (!btn) return;
        changeUserLanguage(btn.dataset.lang);
        langMenu.classList.remove("show");
      });
    }
  </script>
</body>
</html>
