#include <WiFi.h>
#include <SPI.h>
#include <MFRC522.h>
#include <Firebase_ESP_Client.h>

// âœ… à¸ªà¹ˆà¸§à¸™à¹€à¸ªà¸£à¸´à¸¡ Firebase
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

#include <time.h>

/* ================= LED STATUS ================= */
#define LED_PIN 2 

/* ================= WiFi ================= */
#define WIFI_SSID     "SEEKUBALIK"
#define WIFI_PASSWORD "123456878"

/* ================= Firebase ================= */
#define FIREBASE_HOST "https://smartwaste2568-1d792-default-rtdb.asia-southeast1.firebasedatabase.app"
#define FIREBASE_API_KEY "AIzaSyA9SQW3iUwZWCgeG6eOYvvMU5g2hb_Zlrw"

#define USER_EMAIL    "esp32@smartwaste.com"
#define USER_PASSWORD "123456"

/* ================= RFID ================= */
#define SS_PIN   5
#define RST_PIN  22
MFRC522 rfid(SS_PIN, RST_PIN);

/* ================= Firebase objects ================= */
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

/* ================= Device ================= */
String DEVICE_ID = "esp32_01";

/* ================= State ================= */
bool wifiConnected = false;
unsigned long lastScanMillis = 0;

/* ================= Helper ================= */
String uidToString(MFRC522::Uid uid) {
  String s = "";
  for (byte i = 0; i < uid.size; i++) {
    if (uid.uidByte[i] < 0x10) s += "0";
    s += String(uid.uidByte[i], HEX);
  }
  s.toUpperCase();
  return s;
}

/* ================= Setup ================= */
void setup() {
  Serial.begin(115200);
  Serial.println("\n=== ESP32 START ===");

  // âœ… 1. à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: à¹ƒà¸«à¹‰à¹„à¸Ÿà¸”à¸±à¸šà¹„à¸§à¹‰à¸à¹ˆà¸­à¸™
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW); 

  /* RFID */
  SPI.begin(18, 19, 23, SS_PIN);
  rfid.PCD_Init();
  Serial.println("RFID READY");

  /* WiFi */
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting WiFi");

  // âœ… 2. à¸‚à¸“à¸°à¹€à¸Šà¸·à¹ˆà¸­à¸¡ WiFi: à¹„à¸¡à¹ˆà¸à¸£à¸°à¸žà¸£à¸´à¸š (à¸”à¸±à¸šà¸™à¸´à¹ˆà¸‡à¹†)
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  wifiConnected = true;
  Serial.println("\nâœ… WiFi Connected");
  Serial.println(WiFi.localIP());

  /* Firebase Config */
  config.api_key = FIREBASE_API_KEY;
  config.database_url = FIREBASE_HOST;
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;
  config.token_status_callback = tokenStatusCallback;

  // âœ… à¹€à¸žà¸´à¹ˆà¸¡: à¸›à¸£à¸±à¸š Buffer à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² SSL Error à¸«à¸¥à¸¸à¸”à¸šà¹ˆà¸­à¸¢
  fbdo.setBSSLBufferSize(1024, 1024);
  config.timeout.socketConnection = 10000;
  
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  /* Time Setup */
  // à¹ƒà¸Šà¹‰ Google NTP à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§
  configTime(7 * 3600, 0, "time.google.com", "pool.ntp.org", "time.nist.gov");
  
  Serial.print("Syncing Time");

  // âœ… 3. à¹€à¸Šà¸·à¹ˆà¸­à¸¡ WiFi à¹„à¸”à¹‰à¹à¸¥à¹‰à¸§ à¹à¸•à¹ˆà¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸£à¸°à¸šà¸š (Sync Time/Firebase): à¹ƒà¸«à¹‰à¸à¸£à¸°à¸žà¸£à¸´à¸š
  while (time(nullptr) < 1000000000) {
    digitalWrite(LED_PIN, !digitalRead(LED_PIN)); // à¸ªà¸±à¹ˆà¸‡à¸à¸£à¸°à¸žà¸£à¸´à¸š
    delay(250);
    Serial.print(".");
  }
  Serial.println("\nâœ… Time Synced");
  
  Serial.print("Firebase ready = ");
  Serial.println(Firebase.ready());

  // âœ… 4. à¹€à¸ªà¸£à¹‡à¸ˆà¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡: à¹„à¸Ÿà¸•à¸´à¸”à¸„à¹‰à¸²à¸‡
  digitalWrite(LED_PIN, HIGH);
}

/* ================= Loop ================= */
void loop() {
  /* à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š WiFi */
  if (WiFi.status() != WL_CONNECTED) {
    if (wifiConnected) {
      Serial.println("ðŸ“¶ WiFi LOST");
      wifiConnected = false;
      // âœ… 5. à¸–à¹‰à¸²à¹€à¸™à¹‡à¸•à¸«à¸¥à¸¸à¸”: à¹„à¸Ÿà¸”à¸±à¸š
      digitalWrite(LED_PIN, LOW);
    }
    delay(1000);
    return;
  }

  // à¸–à¹‰à¸²à¸à¸¥à¸±à¸šà¸¡à¸²à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰à¹à¸¥à¹‰à¸§
  if (!wifiConnected) {
    wifiConnected = true;
    Serial.println("âœ… WiFi RECONNECTED");
    // à¸à¸¥à¸±à¸šà¸¡à¸²à¸•à¸´à¸”à¸„à¹‰à¸²à¸‡
    digitalWrite(LED_PIN, HIGH);
  }

  if (!Firebase.ready()) {
    return;
  }

  /* à¸à¸±à¸™à¸ªà¹à¸à¸™à¸£à¸±à¸§ (Cooldown 2 à¸§à¸´) */
  if (millis() - lastScanMillis < 2000) return;

  /* RFID */
  if (!rfid.PICC_IsNewCardPresent()) return;
  if (!rfid.PICC_ReadCardSerial()) return;

  lastScanMillis = millis();

  // (Optional) à¸à¸£à¸°à¸žà¸£à¸´à¸šà¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸­à¹ˆà¸²à¸™à¸šà¸±à¸•à¸£ (à¸”à¸±à¸šà¸™à¸´à¸”à¸™à¸¶à¸‡à¹à¸¥à¹‰à¸§à¸•à¸´à¸”à¸•à¹ˆà¸­)
  digitalWrite(LED_PIN, LOW);
  delay(100);
  digitalWrite(LED_PIN, HIGH);

  String rfidUID = uidToString(rfid.uid);
  Serial.println("ðŸ“Œ RFID SCANNED = " + rfidUID);

  sendRFIDEvent(rfidUID);

  rfid.PICC_HaltA();
  rfid.PCD_StopCrypto1(); 
}

/* ================= Send Event ================= */
void sendRFIDEvent(String rfidUID) {
  
  FirebaseJson json;
  json.set("rfid", rfidUID);
  json.set("time", (double)time(nullptr) * 1000); 

  // Path à¸„à¸·à¸­à¸•à¸±à¸§ esp32_01 à¹€à¸¥à¸¢ (à¹„à¸¡à¹ˆà¸¡à¸µ ID à¸¢à¹ˆà¸­à¸¢à¸•à¹ˆà¸­à¸—à¹‰à¸²à¸¢)
  String path = "/rfid_events/" + DEVICE_ID;
  Serial.print("Updating " + path + "... ");

  // âœ… à¹ƒà¸Šà¹‰ setJSON à¹€à¸žà¸·à¹ˆà¸­à¹€à¸‚à¸µà¸¢à¸™à¸—à¸±à¸š (Update) à¸„à¹ˆà¸²à¹€à¸”à¸´à¸¡
  if (Firebase.RTDB.setJSON(&fbdo, path, &json)) {
    Serial.println("âœ… UPDATE SUCCESS");
  } else {
    Serial.println("âŒ FAILED");
    Serial.println("REASON: " + fbdo.errorReason());
  }
}