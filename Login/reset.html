<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Waste - ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>

  <style>
    /* --- CSS Core Theme --- */
    :root {
      --primary: #10b981;
      --primary-dark: #047857;
      --accent: #0ea5e9;
      --bg-color: #f0fdf4;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(255, 255, 255, 0.8);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Prompt", sans-serif; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background-color: var(--bg-color); position: relative;
    }

    /* Background Blobs */
    .bg-shape {
      position: absolute; border-radius: 50%; filter: blur(80px);
      z-index: 0; opacity: 0.6; animation: blobFloat 10s infinite alternate; pointer-events: none;
    }
    .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #34d399; }
    .blob-2 { bottom: -10%; right: -10%; width: 600px; height: 600px; background: #38bdf8; animation-delay: -2s; }
    .blob-3 { top: 40%; left: 40%; width: 300px; height: 300px; background: #2dd4bf; animation-delay: -5s; }
    @keyframes blobFloat { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }

    /* Mobile Logo (Fixed Top Left) */
    .mobile-logo-fixed {
      display: none; position: absolute; top: 20px; left: 20px; z-index: 50;
      text-decoration: none;
    }
    .mobile-logo-fixed .brand-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px);
      color: var(--primary-dark); padding: 8px 16px; border-radius: 50px; 
      font-weight: 600; font-size: 14px; border: 1px solid rgba(16, 185, 129, 0.2);
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    /* Lang Switcher (Right Top) */
    .lang-switcher { position: absolute; top: 20px; right: 20px; z-index: 50; }
    .lang-switcher .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255,255,255,0.9); backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
      cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .lang-switcher .icon-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(15, 23, 42, 0.16); }
    .lang-switcher .icon-btn:active { transform: scale(0.96); }
    .lang-switcher .icon-btn i { font-size: 22px; color: #0f172a; }

    .lang-menu {
      position: absolute; top: 54px; right: 0;
      background: #fff; padding: 8px; border-radius: 18px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18);
      display: none; flex-direction: column; gap: 6px; min-width: 190px;
    }
    .lang-menu.show { display: flex; animation: scaleIn 0.2s ease; }
    .lang-menu button {
      background: transparent; border: none; padding: 10px 12px; text-align: left;
      border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; color: #0f172a;
    }
    .lang-menu button:hover { background: #f1f5f9; }
    .lang-menu button.active { background: #e0f2fe; color: var(--accent, #0ea5e9); font-weight: 700; }

    /* Main Container */
    .container {
      position: relative; z-index: 10;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }

    /* Card Design */
    .card {
      width: 100%; max-width: 400px;
      background: var(--glass-bg); backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); border-radius: 28px; padding: 2.5rem;
      box-shadow: var(--shadow-lg); text-align: center;
      animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .icon-header {
      width: 60px; height: 60px; background: rgba(16, 185, 129, 0.1);
      color: var(--primary); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; margin: 0 auto 20px auto;
    }

    h2 { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
    p.desc { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 30px; line-height: 1.5; }

    /* Inputs */
    .input-wrapper { position: relative; margin-bottom: 20px; text-align: left; }
    
    .input-icon {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: #94a3b8; font-size: 1.2rem; z-index: 5; pointer-events: none;
    }
    
    .toggle-password {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      color: #cbd5e1; font-size: 1.2rem; z-index: 5; cursor: pointer; transition: 0.2s;
    }
    .toggle-password:hover { color: var(--primary); }

    input {
      width: 100%; height: 50px; 
      padding: 0 48px 0 48px; 
      border: 2px solid transparent; background: #f8fafc; border-radius: 14px;
      font-size: 1rem; color: var(--text-main); transition: 0.2s;
    }
    input[type="password"]::-ms-reveal,
    input[type="password"]::-ms-clear { display: none; }
    input:focus { outline: none; background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
    input:focus + .input-icon { color: var(--primary); }

    button {
      width: 100%; height: 54px;
      background: linear-gradient(90deg, #10b981, #059669); color: white;
      border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 600;
      cursor: pointer; box-shadow: 0 8px 16px rgba(16, 185, 129, 0.25);
      transition: transform 0.1s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 12px 20px rgba(16, 185, 129, 0.3); }
    button:active { transform: scale(0.97); }
    button:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }

    .back-link {
      display: inline-block; margin-top: 25px;
      color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500;
      transition: 0.2s;
    }
    .back-link:hover { color: var(--primary); }

    /* Responsive */
    @media (max-width: 600px) {
      .lang-switcher { top: 16px; right: 16px; }
      .mobile-logo-fixed { display: flex; } /* ‡πÇ‡∏ä‡∏ß‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      .card { padding: 30px 20px; max-width: 100%; }
      h2 { font-size: 1.6rem; }
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="bg-shape blob-1"></div>
  <div class="bg-shape blob-2"></div>
  <div class="bg-shape blob-3"></div>

  <a href="login.html" class="mobile-logo-fixed">
    <div class="brand-badge"><i class="ri-recycle-line"></i> Smart Waste</div>
  </a>

  <div class="lang-switcher">
    <button class="icon-btn" id="langIconBtn" type="button" aria-label="Change language">
      <i class="ri-global-line" aria-hidden="true"></i>
    </button>
    <div class="lang-menu" id="langMenu">
      <button type="button" data-lang="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
      <button type="button" data-lang="en">üá¨üáß English</button>
      <button type="button" data-lang="ms">üá≤üáæ Bahasa Melayu</button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2 id="resetTitle">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
      <p class="desc" id="resetDesc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>
      
      <form id="resetForm">
        <div class="input-wrapper">
          <i class="ri-lock-2-line input-icon"></i>
          <input type="password" id="newPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" required minlength="6">
          <i class="ri-eye-off-line toggle-password" onclick="togglePass()"></i>
        </div>
        <button type="submit" id="btnSubmit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
      </form>

      <a href="login.html" class="back-link">
        <i class="ri-arrow-left-line"></i> <span id="resetBackLink">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
      </a>
    </div>
  </div>

  <script>
    // --- Firebase Config ---
    var firebaseConfig = {
      apiKey: "AIzaSyA9SQW3iUwZWCgeG6eOYvvMU5g2hb_Zlrw",
      authDomain: "smartwaste2568-1d792.firebaseapp.com",
      projectId: "smartwaste2568-1d792",
      storageBucket: "smartwaste2568-1d792.firebasestorage.app",
      messagingSenderId: "1041339993312",
      appId: "1:1041339993312:web:65b26ea83dcbf4f8b29485"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // --- i18n (Reset Password) ---
    const fallbackDict = {
      th: {
        pageTitle_reset: "Smart Waste - ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
        resetTitle: "‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
        resetDesc: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£",
        resetPasswordPh: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
        resetSubmit: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™",
        resetBack: "‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
        invalidLinkTitle: "‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
        invalidLinkText: "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß",
        invalidLinkConfirm: "‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
        shortPassTitle: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ",
        shortPassText: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£",
        saving: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",
        successTitle: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
        successText: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
        successConfirm: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
        errorTitle: "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        errorConfirm: "‡∏ï‡∏Å‡∏•‡∏á",
        errExpiredLink: "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ç‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà",
        errInvalidLink: "‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß",
        errWeakPassword: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ",
        errorGeneric: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"
      },
      en: {
        pageTitle_reset: "Smart Waste - Reset Password",
        resetTitle: "Reset Password",
        resetDesc: "Create a new password to access your account.<br>Please use at least 6 characters.",
        resetPasswordPh: "New password",
        resetSubmit: "Confirm password reset",
        resetBack: "Back to login",
        invalidLinkTitle: "Invalid link",
        invalidLinkText: "This link may have expired or already been used.",
        invalidLinkConfirm: "Back to login",
        shortPassTitle: "Password too short",
        shortPassText: "Please use at least 6 characters.",
        saving: "Saving...",
        successTitle: "Success!",
        successText: "Your password has been reset.",
        successConfirm: "Sign in now",
        errorTitle: "Failed",
        errorConfirm: "OK",
        errExpiredLink: "This link has expired. Please request a new one.",
        errInvalidLink: "This link is invalid or already used.",
        errWeakPassword: "Password is too weak",
        errorGeneric: "Something went wrong. Please try again."
      },
      ms: {
        pageTitle_reset: "Smart Waste - Tetapkan Semula Kata Laluan",
        resetTitle: "Tetapkan Semula Kata Laluan",
        resetDesc: "Cipta kata laluan baharu untuk akses akaun anda.<br>Sila guna sekurang-kurangnya 6 aksara.",
        resetPasswordPh: "Kata laluan baharu",
        resetSubmit: "Sahkan penetapan semula",
        resetBack: "Kembali ke log masuk",
        invalidLinkTitle: "Pautan tidak sah",
        invalidLinkText: "Pautan ini mungkin tamat tempoh atau telah digunakan.",
        invalidLinkConfirm: "Kembali ke log masuk",
        shortPassTitle: "Kata laluan terlalu pendek",
        shortPassText: "Sila guna sekurang-kurangnya 6 aksara.",
        saving: "Menyimpan...",
        successTitle: "Berjaya!",
        successText: "Kata laluan berjaya ditetapkan semula.",
        successConfirm: "Log masuk sekarang",
        errorTitle: "Gagal",
        errorConfirm: "OK",
        errExpiredLink: "Pautan telah tamat tempoh. Sila minta pautan baharu.",
        errInvalidLink: "Pautan tidak sah atau telah digunakan.",
        errWeakPassword: "Kata laluan terlalu lemah",
        errorGeneric: "Ralat berlaku. Sila cuba lagi."
      }
    };

    let currentLang = localStorage.getItem("sw_lang") || "th";
    document.documentElement.setAttribute("lang", currentLang);

    function tr(key) {
      const primary = window.SW_Translations && window.SW_Translations[currentLang];
      const fallback = fallbackDict[currentLang] || fallbackDict.en;
      return (primary && primary[key]) || fallback[key] || fallbackDict.th[key] || key;
    }

    function applyLanguage() {
      document.title = tr("pageTitle_reset");
      const titleEl = document.getElementById("resetTitle");
      const descEl = document.getElementById("resetDesc");
      const passEl = document.getElementById("newPassword");
      const backEl = document.getElementById("resetBackLink");
      if (titleEl) titleEl.textContent = tr("resetTitle");
      if (descEl) descEl.innerHTML = tr("resetDesc");
      if (passEl) passEl.placeholder = tr("resetPasswordPh");
      if (backEl) backEl.textContent = tr("resetBack");
      const btn = document.getElementById("btnSubmit");
      if (btn && !btn.disabled) btn.textContent = tr("resetSubmit");
    }

    applyLanguage();

    const langIconBtn = document.getElementById("langIconBtn");
    const langMenu = document.getElementById("langMenu");

    function updateLangMenu() {
      if (!langMenu) return;
      langMenu.querySelectorAll("button").forEach(b => {
        b.classList.toggle("active", b.dataset.lang === currentLang);
      });
    }

    function setLang(lang) {
      if (!lang || lang === currentLang) return;
      currentLang = lang;
      try { localStorage.setItem("sw_lang", currentLang); } catch (_) {}
      document.documentElement.setAttribute("lang", currentLang);
      applyLanguage();
      updateLangMenu();
    }

    if (langIconBtn && langMenu) {
      langIconBtn.addEventListener("click", () => langMenu.classList.toggle("show"));
      langMenu.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-lang]");
        if (!btn) return;
        setLang(btn.dataset.lang);
        langMenu.classList.remove("show");
      });
      document.addEventListener("click", (e) => {
        const inMenu = langMenu.contains(e.target) || langIconBtn.contains(e.target);
        if (!inMenu) langMenu.classList.remove("show");
      });
      updateLangMenu();
    }

    window.addEventListener("storage", (e) => {
      if (e.key !== "sw_lang") return;
      const lang = e.newValue || "th";
      if (lang && lang !== currentLang) {
        currentLang = lang;
        document.documentElement.setAttribute("lang", currentLang);
        applyLanguage();
        updateLangMenu();
      }
    });

    // Toggle Password Visibility
    function togglePass() {
      const input = document.getElementById('newPassword');
      const icon = document.querySelector('.toggle-password');
      if (input.type === "password") {
        input.type = "text";
        icon.classList.replace("ri-eye-off-line", "ri-eye-line");
        icon.style.color = "#10b981";
      } else {
        input.type = "password";
        icon.classList.replace("ri-eye-line", "ri-eye-off-line");
        icon.style.color = "#cbd5e1";
      }
    }

    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    const mode = getUrlParameter('mode');
    const actionCode = getUrlParameter('oobCode');
    const btnSubmit = document.getElementById('btnSubmit');

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Link
    if (!actionCode || mode !== 'resetPassword') {
      Swal.fire({
        icon: 'error',
        title: tr("invalidLinkTitle"),
        text: tr("invalidLinkText"),
        confirmButtonText: tr("invalidLinkConfirm"),
        confirmButtonColor: '#10b981',
        allowOutsideClick: false
      }).then(() => {
        window.location.href = 'login.html'; 
      });
      btnSubmit.disabled = true;
      document.getElementById('newPassword').disabled = true;
    }

    document.getElementById('resetForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const newPassword = document.getElementById('newPassword').value;

      if(newPassword.length < 6) {
        Swal.fire({ icon: 'warning', title: tr("shortPassTitle"), text: tr("shortPassText"), confirmButtonColor: '#eab308' });
        return;
      }

      btnSubmit.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> ${tr("saving")}`;
      btnSubmit.disabled = true;

      auth.confirmPasswordReset(actionCode, newPassword)
        .then(() => {
          Swal.fire({
            icon: 'success',
            title: tr("successTitle"),
            text: tr("successText"),
            confirmButtonText: tr("successConfirm"),
            confirmButtonColor: '#10b981',
            allowOutsideClick: false
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = 'login.html'; 
            }
          });
        })
        .catch((error) => {
          btnSubmit.innerHTML = tr("resetSubmit");
          btnSubmit.disabled = false;
          
          let msg = tr("errorGeneric");
          if (error.code === 'auth/expired-action-code') msg = tr("errExpiredLink");
          if (error.code === 'auth/invalid-action-code') msg = tr("errInvalidLink");
          if (error.code === 'auth/weak-password') msg = tr("errWeakPassword");

          Swal.fire({
            icon: 'error',
            title: tr("errorTitle"),
            text: msg,
            confirmButtonText: tr("errorConfirm"),
            confirmButtonColor: '#ef4444'
          });
        });
    });
  </script>

</body>
</html>
